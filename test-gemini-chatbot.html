<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Gemini Chatbot - Vision AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .status-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-indicator.connected {
            background: #44ff44;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom-left-radius: 4px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-preview:hover {
            transform: scale(1.05);
        }

        .typing-indicator {
            display: none;
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4285f4;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input {
            background: white;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .text-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
            resize: none;
            min-height: 45px;
            max-height: 120px;
        }

        .text-input:focus {
            border-color: #4285f4;
        }

        .send-button {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .selected-image {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            display: none;
        }

        .selected-image img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
        }

        .remove-image {
            margin-left: 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .error-message {
            background: #ffe6e6;
            color: #d32f2f;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #d32f2f;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
                max-width: none;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="status-indicator" id="statusIndicator"></div>
            <h1>ü§ñ Gemini Vision AI</h1>
            <p>Chat v·ªõi AI v√† upload h√¨nh ·∫£nh ƒë·ªÉ ph√¢n t√≠ch thi·∫øt k·∫ø</p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-avatar">G</div>
                <div class="message-content">
                    Xin ch√†o! T√¥i l√† Gemini AI v·ªõi kh·∫£ nƒÉng nh√¨n v√† hi·ªÉu h√¨nh ·∫£nh. B·∫°n c√≥ th·ªÉ:
                    <br>‚Ä¢ Upload ·∫£nh thi·∫øt k·∫ø n·ªôi th·∫•t ƒë·ªÉ t√¥i ph√¢n t√≠ch
                    <br>‚Ä¢ H·ªèi v·ªÅ m√†u s·∫Øc, phong c√°ch, v·∫≠t li·ªáu
                    <br>‚Ä¢ Chat b·∫±ng ti·∫øng Vi·ªát ho·∫∑c ti·∫øng Anh
                    <br><br>H√£y th·ª≠ upload m·ªôt ·∫£nh v√† h·ªèi t√¥i nh√©! üì∏‚ú®
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                Gemini ƒëang suy nghƒ©
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chat-input">
            <div class="selected-image" id="selectedImage">
                <img id="selectedImagePreview" src="" alt="Selected image">
                <button class="remove-image" onclick="removeSelectedImage()">‚úï X√≥a</button>
            </div>
            
            <div class="input-container">
                <div class="file-input-wrapper">
                    <input type="file" id="imageInput" accept="image/*" onchange="handleImageSelect(event)">
                    <label for="imageInput" class="file-input-label" title="Upload ·∫£nh">
                        üìé
                    </label>
                </div>
                
                <textarea 
                    id="messageInput" 
                    class="text-input" 
                    placeholder="Nh·∫≠p tin nh·∫Øn ho·∫∑c upload ·∫£nh ƒë·ªÉ ph√¢n t√≠ch..."
                    onkeypress="handleKeyPress(event)"
                    rows="1"
                ></textarea>
                
                <button id="sendButton" class="send-button" onclick="sendMessage()" title="G·ª≠i tin nh·∫Øn">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // K·∫øt n·ªëi Socket.IO t·ªõi namespace Gemini
        const socket = io('/gemini');
        
        let selectedImage = null;
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.getElementById('statusIndicator');
        const selectedImageDiv = document.getElementById('selectedImage');
        const selectedImagePreview = document.getElementById('selectedImagePreview');

        // X·ª≠ l√Ω k·∫øt n·ªëi Socket.IO
        socket.on('connect', () => {
            console.log('‚úÖ K·∫øt n·ªëi Gemini th√†nh c√¥ng:', socket.id);
            statusIndicator.classList.add('connected');
            addMessage('bot', 'üü¢ K·∫øt n·ªëi Gemini th√†nh c√¥ng! S·∫µn s√†ng chat v√† ph√¢n t√≠ch h√¨nh ·∫£nh.');
        });

        socket.on('disconnect', () => {
            console.log('‚ùå M·∫•t k·∫øt n·ªëi Gemini');
            statusIndicator.classList.remove('connected');
            addMessage('bot', 'üî¥ M·∫•t k·∫øt n·ªëi. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...');
        });

        socket.on('connect_error', (error) => {
            console.error('‚ùå L·ªói k·∫øt n·ªëi:', error);
            addMessage('bot', '‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, true);
        });

        // Nh·∫≠n ph·∫£n h·ªìi t·ª´ Gemini
        socket.on('bot_response', (data) => {
            console.log('üì® Nh·∫≠n ph·∫£n h·ªìi t·ª´ Gemini:', data);
            hideTyping();
            addMessage('bot', data.response || data.message || 'Ph·∫£n h·ªìi tr·ªëng t·ª´ Gemini');
        });

        // Nh·∫≠n l·ªói t·ª´ server
        socket.on('error_response', (data) => {
            console.error('‚ùå L·ªói t·ª´ Gemini:', data);
            hideTyping();
            addMessage('bot', '‚ùå L·ªói: ' + (data.error || data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), true);
        });

        // Test k·∫øt n·ªëi Gemini
        socket.on('test_response', (data) => {
            console.log('üß™ Test response:', data);
            addMessage('bot', '‚úÖ Test Gemini: ' + data.message);
        });

        // Test k·∫øt n·ªëi ngay khi load
        socket.emit('test_connection', { message: 'Test k·∫øt n·ªëi Gemini t·ª´ web interface' });

        function addMessage(sender, content, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'G';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            if (isError) {
                messageContent.style.background = '#ffe6e6';
                messageContent.style.color = '#d32f2f';
                messageContent.style.borderLeft = '4px solid #d32f2f';
            }
            
            // X·ª≠ l√Ω text v·ªõi line breaks
            messageContent.innerHTML = content.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addImageMessage(sender, imageData, text = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'G';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (imageData) {
                const img = document.createElement('img');
                img.src = imageData;
                img.className = 'image-preview';
                img.onclick = () => window.open(imageData, '_blank');
                messageContent.appendChild(img);
            }
            
            if (text) {
                const textDiv = document.createElement('div');
                textDiv.innerHTML = text.replace(/\n/g, '<br>');
                textDiv.style.marginTop = imageData ? '8px' : '0';
                messageContent.appendChild(textDiv);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (5MB)
            if (file.size > 5 * 1024 * 1024) {
                addMessage('bot', '‚ùå File qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 5MB.', true);
                return;
            }

            // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
            if (!file.type.startsWith('image/')) {
                addMessage('bot', '‚ùå Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh!', true);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImage = e.target.result;
                selectedImagePreview.src = selectedImage;
                selectedImageDiv.style.display = 'block';
                
                console.log('üì∏ ƒê√£ ch·ªçn ·∫£nh:', file.name, 'Size:', (file.size / 1024).toFixed(2) + 'KB');
            };
            reader.readAsDataURL(file);
        }

        function removeSelectedImage() {
            selectedImage = null;
            selectedImageDiv.style.display = 'none';
            document.getElementById('imageInput').value = '';
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (!message && !selectedImage) {
                messageInput.focus();
                return;
            }

            // Disable g·ª≠i tin nh·∫Øn
            sendButton.disabled = true;
            messageInput.disabled = true;

            try {
                if (selectedImage) {
                    // G·ª≠i tin nh·∫Øn c√≥ ·∫£nh
                    addImageMessage('user', selectedImage, message);
                    
                    console.log('üì§ G·ª≠i ·∫£nh + text t·ªõi Gemini:', {
                        text: message,
                        imageSize: selectedImage.length
                    });
                    
                    socket.emit('user_image', {
                        image: selectedImage,
                        message: message || 'H√£y ph√¢n t√≠ch ·∫£nh n√†y cho t√¥i.'
                    });
                    
                    removeSelectedImage();
                } else {
                    // G·ª≠i tin nh·∫Øn text th√¥ng th∆∞·ªùng
                    addMessage('user', message);
                    
                    console.log('üì§ G·ª≠i text t·ªõi Gemini:', message);
                    
                    socket.emit('user_message', {
                        message: message
                    });
                }

                messageInput.value = '';
                autoResize();
                showTyping();
                
            } catch (error) {
                console.error('‚ùå L·ªói g·ª≠i tin nh·∫Øn:', error);
                addMessage('bot', '‚ùå L·ªói g·ª≠i tin nh·∫Øn: ' + error.message, true);
                hideTyping();
            } finally {
                // Re-enable sau 2 gi√¢y
                setTimeout(() => {
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }, 2000);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        // Auto resize textarea
        messageInput.addEventListener('input', autoResize);

        // Focus v√†o input khi load
        window.addEventListener('load', () => {
            messageInput.focus();
        });

        // Test ƒë·ªãnh k·ª≥ k·∫øt n·ªëi
        setInterval(() => {
            if (socket.connected) {
                socket.emit('test_connection', { 
                    message: 'Ping test', 
                    timestamp: new Date().toISOString() 
                });
            }
        }, 30000); // Test m·ªói 30 gi√¢y
    </script>
</body>
</html>
