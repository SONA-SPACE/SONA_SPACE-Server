<link rel="stylesheet" href="/scss/style.css">
<!-- Th√™m jQuery v√† Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Th√™m Ant Design -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4.24.15/dist/antd.min.css">
<script src="https://cdn.jsdelivr.net/npm/antd@4.24.15/dist/antd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>

<style>
  /* Table header filter styles */
  th.filterable {
    position: relative;
    padding-right: 25px;
    /* Add space for the filter icon */
  }

  .header-filter {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    display: inline-block;
    cursor: pointer;
    width: 20px;
    height: 20px;
    text-align: center;
    line-height: 20px;
  }

  .filter-icon {
    color: #666;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .header-filter:hover .filter-icon {
    color: #333;
  }

  .header-filter.active .filter-icon {
    transform: rotate(180deg);
    color: #007bff;
  }

  .header-filter .filter-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    min-width: 180px;
    background-color: #fff;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    padding: 8px 0;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
  }

  .header-filter.active .filter-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .filter-dropdown .filter-item {
    display: block;
    padding: 8px 16px;
    color: #333;
    text-decoration: none;
    font-size: 14px;
    transition: background-color 0.2s ease;
  }

  .filter-dropdown .filter-item:hover {
    background-color: #f5f5f5;
  }

  /* Return status badge styles */
  .return-status.badge {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 500;
  }

  .badge-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
  }

  .badge-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  .badge-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .badge-danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .badge-primary {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #a6d5fa;
  }

  .order-status-select {
    appearance: auto;
    -webkit-appearance: auto;
    -moz-appearance: auto;
  }

  .badge-secondary {
    background-color: #e2e3e5;
    color: #383d41;
    border: 1px solid #c6c8ca;
    width: 100%;
    text-align: left;
  }

  /* Return status select dropdown styles */
  .return-status-select {
    width: 100%;
    min-width: 180px;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    background-color: #fff;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .return-status-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }

  .return-status-select:hover {
    border-color: #bbb;
  }

  .return-status-select option {
    padding: 4px 8px;
  }

  .return-status-select option:disabled {
    background-color: #f5f5f5;
    color: #999;
  }

  /* Order status select dropdown styles */
  .order-status-select {
    width: 100%;
    min-width: 150px;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .order-status-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }

  .order-status-select:hover {
    border-color: #bbb;
  }

  /* Order status colors based on current status */
  .order-status-select[data-current-status="PENDING"] {
    background-color: #fff3cd;
    color: #856404;
    border-color: #ffeaa7;
  }

  .order-status-select[data-current-status="CONFIRMED"] {
    background-color: #d1ecf1;
    color: #0c5460;
    border-color: #bee5eb;
  }

  .order-status-select[data-current-status="SHIPPING"] {
    background-color: #cce7ff;
    color: #004085;
    border-color: #a6d5fa;
  }

  .order-status-select[data-current-status="SUCCESS"] {
    background-color: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
  }

  .order-status-select[data-current-status="FAILED"] {
    background-color: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
  }

  .order-status-select[data-current-status="CANCELLED"] {
    background-color: #e2e3e5;
    color: #383d41;
    border-color: #c6c8ca;
  }

  .order-status-select[data-current-status="RETURN"] {
    background-color: #fde2e4;
    color: #fd7e14;
    border-color: #fd7e14;
  }
</style>

<!-- Trang qu·∫£n l√Ω ƒë∆°n h√†ng -->
<div class="orders-page">
  <div class="content-wrapper">
    <div class="content-header">
      <div class="container-fluid">
        <div class="page-header">
          <h1>ƒê∆°n h√†ng</h1>

        </div>

        <div class="search-bar">
          <div class="search-input">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng..." id="search-orders">
          </div>

          <div class="date-range">
            <i class="far fa-calendar-alt calendar-icon"></i>
            <span>1/05/2025 - 31/5/2025</span>
          </div>

          <div class="filter-btn">
            <span>Hi·ªÉn th·ªã 6 tr√™n t·ªïng s·ªë 500</span>
          </div>
        </div>

        <div class="orders-summary">
          <div class="summary-card">
            <div class="card-title">T·ªïng ƒë∆°n h√†ng</div>
            <div class="card-value" id="total-orders">0</div>
          </div>

          <div class="summary-card">
            <div class="card-title">ƒê∆°n h√†ng</div>
            <div class="card-subtitle">ƒê∆°n h√†ng ƒëang ch·ªù x·ª≠ l√Ω</div>
            <div class="card-value" id="pending-orders">0</div>
          </div>

          <div class="summary-card">
            <div class="card-title">ƒêang v·∫≠n chuy·ªÉn</div>
            <div class="card-subtitle">T·ªïng ƒë∆°n h√†ng ƒëang v·∫≠n chuy·ªÉn</div>
            <div class="card-value" id="shipping-orders">0</div>
          </div>

          <div class="summary-card">
            <div class="card-title">Ho√†n tr·∫£ ƒë∆°n h√†ng</div>
            <div class="card-subtitle">ƒê∆°n h√†ng ƒë∆∞·ª£c y√™u c·∫ßu tr·∫£ h√†ng</div>
            <div class="card-value" id="return-orders">0</div>
          </div>

          <div class="summary-card">
            <div class="card-title">H·ªßy ƒë∆°n h√†ng</div>
            <div class="card-subtitle">ƒê∆°n h√†ng ƒë∆∞·ª£c y√™u c·∫ßu h·ªßy</div>
            <div class="card-value" id="cancel-orders">0</div>
          </div>
        </div>

        <div class="orders-table">
          <table>
            <thead>
              <tr>


                <th class="filterable">
                  M√£ ƒë∆°n h√†ng
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="order-asc">TƒÉng d·∫ßn (A-Z)</a>
                      <a class="filter-item" href="#" data-sort="order-desc">Gi·∫£m d·∫ßn (Z-A)</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  Ng√†y ƒë·∫∑t
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="date-asc">C≈© nh·∫•t tr∆∞·ªõc</a>
                      <a class="filter-item" href="#" data-sort="date-desc">M·ªõi nh·∫•t tr∆∞·ªõc</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  Kh√°ch h√†ng
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="customer-asc">T√™n (A-Z)</a>
                      <a class="filter-item" href="#" data-sort="customer-desc">T√™n (Z-A)</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  Thanh to√°n
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="payment-paid">ƒê√£ thanh to√°n</a>
                      <a class="filter-item" href="#" data-sort="payment-unpaid">Ch∆∞a thanh to√°n</a>
                      <a class="filter-item" href="#" data-sort="payment-all">T·∫•t c·∫£</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  S·∫£n ph·∫©m
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="products-asc">S·ªë l∆∞·ª£ng tƒÉng d·∫ßn</a>
                      <a class="filter-item" href="#" data-sort="products-desc">S·ªë l∆∞·ª£ng gi·∫£m d·∫ßn</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  T·ªïng ti·ªÅn
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="total-asc">Gi√° tr·ªã tƒÉng d·∫ßn</a>
                      <a class="filter-item" href="#" data-sort="total-desc">Gi√° tr·ªã gi·∫£m d·∫ßn</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  Ho√†n tr·∫£ ƒêH
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="return-none">Kh√¥ng c√≥ ho√†n tr·∫£</a>
                      <a class="filter-item" href="#" data-sort="return-pending">ƒêang ch·ªù x·ª≠ l√Ω</a>
                      <a class="filter-item" href="#" data-sort="return-approved">ƒê√£ duy·ªát tr·∫£ h√†ng</a>
                      <a class="filter-item" href="#" data-sort="return-cancel-confirmed">X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng</a>
                      <a class="filter-item" href="#" data-sort="return-cancelled">ƒê√£ h·ªßy ho√†n t·∫•t</a>
                      <a class="filter-item" href="#" data-sort="return-rejected">T·ª´ ch·ªëi tr·∫£ h√†ng</a>
                      <a class="filter-item" href="#" data-sort="return-all">T·∫•t c·∫£</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  Tr·∫°ng th√°i
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="status-pending">Ch·ªù x√°c nh·∫≠n</a>
                      <a class="filter-item" href="#" data-sort="status-confirmed">ƒê√£ x√°c nh·∫≠n</a>
                      <a class="filter-item" href="#" data-sort="status-shipping">ƒêang giao</a>
                      <a class="filter-item" href="#" data-sort="status-success">Giao h√†ng th√†nh c√¥ng</a>
                      <a class="filter-item" href="#" data-sort="status-failed">Th·∫•t b·∫°i</a>
                      <a class="filter-item" href="#" data-sort="status-cancelled">ƒê√£ h·ªßy</a>
                      <a class="filter-item" href="#" data-sort="status-return">ƒêang ho√†n tr·∫£</a>
                      <a class="filter-item" href="#" data-sort="status-all">T·∫•t c·∫£</a>
                    </div>
                  </div>
                </th>
                <th class="filterable">
                  Ph∆∞∆°ng th·ª©c TT
                  <div class="header-filter">
                    <i class="fas fa-chevron-down filter-icon"></i>
                    <div class="filter-dropdown">
                      <a class="filter-item" href="#" data-sort="payment-method-cod">COD</a>
                      <a class="filter-item" href="#" data-sort="payment-method-bank">Chuy·ªÉn kho·∫£n</a>
                      <a class="filter-item" href="#" data-sort="payment-method-vnpay">VNPay</a>
                      <a class="filter-item" href="#" data-sort="payment-method-momo">MoMo</a>
                      <a class="filter-item" href="#" data-sort="payment-method-zalopay">ZaloPay</a>
                      <a class="filter-item" href="#" data-sort="payment-method-all">T·∫•t c·∫£</a>
                    </div>
                  </div>
                </th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="orders-list">
              <!-- D·ªØ li·ªáu ƒë∆°n h√†ng m·∫´u -->
              <!-- <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status processing">Y√™u c·∫ßu h·ªßy</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr>
              
              <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status processing">Ch·ªù x√°c nh·∫≠n</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr>
              
              <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status processing">Y√™u c·∫ßu h·ªßy</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr>
              
              <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status delivered">ƒê√£ h·ªßy</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr>
              
              <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status shipped">ƒêang giao</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr>
              
              <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status processing">Y√™u c·∫ßu tr·∫£ h√†ng</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr>
              
              <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status delivered">Tr·∫£ h√†ng</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr>
              
              <tr>
                <td><input type="checkbox" class="checkbox"></td>
                <td class="order-id">ORD-10586</td>
                <td>16:08:55 8-05-2025</td>
                <td>Nguy·ªÖn X</td>
                <td><span class="status paid">ƒê√£ thanh to√°n</span></td>
                <td>2 s·∫£n ph·∫©m</td>
                <td>15.050.000 ƒë</td>
                <td>-</td>
                <td><span class="status delivered">Giao h√†ng th√†nh c√¥ng</span></td>
                <td>16:08:55 8-05-2025</td>
                <td>
                  <div class="actions">
                    <button class="action-btn"><i class="fas fa-pencil-alt"></i></button>
                    <button class="action-btn"><i class="fas fa-trash-alt"></i></button>
                  </div>
                </td>
              </tr> -->
            </tbody>
          </table>

          <div class="table-footer">
            <div class="showing-info" id="orders-showing-info">Hi·ªÉn th·ªã 1-8 tr√™n t·ªïng s·ªë 20 ƒë∆°n h√†ng</div>
            <div class="pagination">
              <button class="page-item disabled"><i class="fas fa-chevron-left"></i></button>
              <button class="page-item active">1</button>
              <button class="page-item">2</button>
              <button class="page-item">3</button>
              <button class="page-item"><i class="fas fa-chevron-right"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal xem chi ti·∫øt ƒë∆°n h√†ng -->
<div class="modal fade" id="order-detail-modal" tabindex="-1" role="dialog" aria-labelledby="orderDetailModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailModalLabel">Chi ti·∫øt ƒë∆°n h√†ng #<span id="order-id"></span></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="order-detail-content">
        <!-- Chi ti·∫øt ƒë∆°n h√†ng s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
        <button type="button" class="btn btn-primary" id="update-status-btn">C·∫≠p nh·∫≠t tr·∫°ng th√°i</button>
      </div>
    </div>
  </div>
</div>

<!-- X√≥a modal thay ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng v√¨ ƒë√£ kh√¥ng c·∫ßn thi·∫øt n·ªØa -->

<script>
  document.addEventListener('DOMContentLoaded', function () {
    loadOrders(); // üöÄ Load ƒë∆°n h√†ng khi v√†o trang

    // X·ª≠ l√Ω s·ª± ki·ªán cho header filters
    document.querySelectorAll('.filterable').forEach(filter => {
      filter.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        // T√¨m element .header-filter b√™n trong .filterable n√†y
        const headerFilter = this.querySelector('.header-filter');
        if (!headerFilter) return;

        // Toggle active class cho header-filter n√†y
        const isCurrentlyActive = headerFilter.classList.contains('active');

        // Close t·∫•t c·∫£ dropdowns kh√°c
        document.querySelectorAll('.header-filter').forEach(otherFilter => {
          otherFilter.classList.remove('active');
        });

        // Toggle tr·∫°ng th√°i cho header-filter hi·ªán t·∫°i
        if (!isCurrentlyActive) {
          headerFilter.classList.add('active');
        }
      });
    });

    // X·ª≠ l√Ω s·ª± ki·ªán click cho filter items trong header
    document.querySelectorAll('.header-filter .filter-item').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        const sortType = this.getAttribute('data-sort');
        // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang s·∫Øp x·∫øp
        if (window.antd && window.antd.message) {
          window.antd.message.loading('ƒêang s·∫Øp x·∫øp d·ªØ li·ªáu...');
        }

        // Th·ª±c hi·ªán s·∫Øp x·∫øp d·ªØ li·ªáu
        sortOrders(sortType);

        // ƒê√≥ng dropdown sau khi ch·ªçn
        this.closest('.header-filter').classList.remove('active');
      });
    });

    // ƒê√≥ng t·∫•t c·∫£ dropdowns khi click ra ngo√†i
    document.addEventListener('click', function () {
      document.querySelectorAll('.header-filter').forEach(filter => {
        filter.classList.remove('active');
      });
    });

    // X√≥a x·ª≠ l√Ω s·ª± ki·ªán c·∫≠p nh·∫≠t tr·∫°ng th√°i c≈©

    // X·ª≠ l√Ω s·ª± ki·ªán ƒë√≥ng modal
    const closeButtons = document.querySelectorAll('[data-dismiss="modal"]');
    closeButtons.forEach(button => {
      button.addEventListener('click', function () {
        const modalId = this.closest('.modal').id;

        if (typeof $ !== 'undefined') {
          $(`#${modalId}`).modal('hide');
        } else {
          const modal = document.getElementById(modalId);
          modal.classList.remove('show');
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('modal-open');

          // X√≥a backdrop
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.parentNode.removeChild(backdrop);
          }
        }
      });
    });

    // Kh·ªüi t·∫°o Ant Design n·∫øu c·∫ßn
    if (window.antd) {
      // C√≥ th·ªÉ th√™m c√°c c·∫•u h√¨nh kh√°c cho Ant Design ·ªü ƒë√¢y
      if (window.antd.message) {
        window.antd.message.config({
          top: 60,
          duration: 2,
          maxCount: 3,
        });
      }
    }

    // C·∫≠p nh·∫≠t m√†u s·∫Øc c·ªßa select khi thay ƒë·ªïi gi√° tr·ªã
    document.addEventListener('change', function (e) {
      if (e.target && e.target.classList.contains('order-status-select')) {
        // C·∫≠p nh·∫≠t data-current-status ƒë·ªÉ CSS c√≥ th·ªÉ √°p d·ª•ng m√†u s·∫Øc m·ªõi
        e.target.setAttribute('data-current-status', e.target.value);
      }
    });
  });

  // H√†m s·∫Øp x·∫øp ƒë∆°n h√†ng
  function sortOrders(sortType) {
    // L·∫•y t·∫•t c·∫£ c√°c h√†ng trong b·∫£ng
    const tbody = document.getElementById('orders-list');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Helper function to parse custom date format "16:08:55 8-05-2025"
    function parseCustomDate(dateStr) {
      const parts = dateStr.trim().split(' ');
      if (parts.length === 2) {
        const timePart = parts[0]; // "16:08:55"
        const datePart = parts[1]; // "8-05-2025"
        const dateParts = datePart.split('-');
        if (dateParts.length === 3) {
          const day = parseInt(dateParts[0]);
          const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
          const year = parseInt(dateParts[2]);
          const timeParts = timePart.split(':');
          const hour = parseInt(timeParts[0]);
          const minute = parseInt(timeParts[1]);
          const second = parseInt(timeParts[2]);
          return new Date(year, month, day, hour, minute, second);
        }
      }
      return new Date(dateStr); // Fallback
    }

    // S·∫Øp x·∫øp d·ª±a tr√™n lo·∫°i s·∫Øp x·∫øp
    switch (sortType) {
      case 'order-asc':
        rows.sort((a, b) => {
          const aValue = a.querySelector('.order-id').textContent;
          const bValue = b.querySelector('.order-id').textContent;
          return aValue.localeCompare(bValue);
        });
        break;

      case 'order-desc':
        rows.sort((a, b) => {
          const aValue = a.querySelector('.order-id').textContent;
          const bValue = b.querySelector('.order-id').textContent;
          return bValue.localeCompare(aValue);
        });
        break;

      case 'date-asc':
        rows.sort((a, b) => {
          const aDateText = a.querySelectorAll('td')[2].textContent;
          const bDateText = b.querySelectorAll('td')[2].textContent;
          const aValue = parseCustomDate(aDateText);
          const bValue = parseCustomDate(bDateText);
          return aValue - bValue;
        });
        break;

      case 'date-desc':
        rows.sort((a, b) => {
          const aDateText = a.querySelectorAll('td')[2].textContent;
          const bDateText = b.querySelectorAll('td')[2].textContent;
          const aValue = parseCustomDate(aDateText);
          const bValue = parseCustomDate(bDateText);
          return bValue - aValue;
        });
        break;

      case 'customer-asc':
        rows.sort((a, b) => {
          const aValue = a.querySelectorAll('td')[3].textContent;
          const bValue = b.querySelectorAll('td')[3].textContent;
          return aValue.localeCompare(bValue);
        });
        break;

      case 'customer-desc':
        rows.sort((a, b) => {
          const aValue = a.querySelectorAll('td')[3].textContent;
          const bValue = b.querySelectorAll('td')[3].textContent;
          return bValue.localeCompare(aValue);
        });
        break;

      case 'payment-paid':
        // L·ªçc ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng ƒë√£ thanh to√°n
        rows.forEach(row => {
          const paymentStatus = row.querySelectorAll('td')[4].querySelector('.status').textContent;
          row.style.display = paymentStatus.includes('ƒê√£ thanh to√°n') ? '' : 'none';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'payment-unpaid':
        // L·ªçc ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng ch∆∞a thanh to√°n
        rows.forEach(row => {
          const paymentStatus = row.querySelectorAll('td')[4].querySelector('.status').textContent;
          row.style.display = !paymentStatus.includes('ƒê√£ thanh to√°n') ? '' : 'none';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'payment-all':
        // Hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng
        rows.forEach(row => {
          row.style.display = '';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'products-asc':
        // S·∫Øp x·∫øp theo s·ªë l∆∞·ª£ng s·∫£n ph·∫©m tƒÉng d·∫ßn
        rows.sort((a, b) => {
          const aText = a.querySelectorAll('td')[5].textContent;
          const bText = b.querySelectorAll('td')[5].textContent;
          const aValue = parseInt(aText.match(/\d+/)[0]);
          const bValue = parseInt(bText.match(/\d+/)[0]);
          return aValue - bValue;
        });
        break;

      case 'products-desc':
        // S·∫Øp x·∫øp theo s·ªë l∆∞·ª£ng s·∫£n ph·∫©m gi·∫£m d·∫ßn
        rows.sort((a, b) => {
          const aText = a.querySelectorAll('td')[5].textContent;
          const bText = b.querySelectorAll('td')[5].textContent;
          const aValue = parseInt(aText.match(/\d+/)[0]);
          const bValue = parseInt(bText.match(/\d+/)[0]);
          return bValue - aValue;
        });
        break;

      case 'total-asc':
        rows.sort((a, b) => {
          const aValue = parseFloat(a.querySelectorAll('td')[6].textContent.replace(/[^\d]/g, ''));
          const bValue = parseFloat(b.querySelectorAll('td')[6].textContent.replace(/[^\d]/g, ''));
          return aValue - bValue;
        });
        break;

      case 'total-desc':
        rows.sort((a, b) => {
          const aValue = parseFloat(a.querySelectorAll('td')[6].textContent.replace(/[^\d]/g, ''));
          const bValue = parseFloat(b.querySelectorAll('td')[6].textContent.replace(/[^\d]/g, ''));
          return bValue - aValue;
        });
        break;

      // Th√™m x·ª≠ l√Ω cho c√°c tr∆∞·ªùng h·ª£p return status t·ª´ b·∫£ng order_returns
      case 'return-pending':
      case 'return-approved':
      case 'return-cancel-confirmed':
      case 'return-cancelled':
      case 'return-rejected':
        // L·∫•y tr·∫°ng th√°i tr·∫£ h√†ng c·∫ßn l·ªçc
        let returnStatusToFilter;
        if (sortType === 'return-cancel-confirmed') {
          returnStatusToFilter = 'CANCEL_CONFIRMED';
        } else if (sortType === 'return-cancelled') {
          returnStatusToFilter = 'CANCELLED';
        } else {
          returnStatusToFilter = sortType.replace('return-', '').toUpperCase();
        }

        // L·ªçc c√°c ƒë∆°n h√†ng theo tr·∫°ng th√°i tr·∫£ h√†ng trong select dropdown
        rows.forEach(row => {
          const returnSelectElement = row.querySelectorAll('td')[7].querySelector('.return-status-select');
          const returnStatus = returnSelectElement ? returnSelectElement.value : '';

          // Hi·ªÉn th·ªã ƒë∆°n h√†ng n·∫øu tr·∫°ng th√°i kh·ªõp
          row.style.display = (returnStatus === returnStatusToFilter) ? '' : 'none';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'return-none':
        // L·ªçc ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng kh√¥ng c√≥ th√¥ng tin tr·∫£ h√†ng (select value = '')
        rows.forEach(row => {
          const returnSelectElement = row.querySelectorAll('td')[7].querySelector('.return-status-select');
          const returnStatus = returnSelectElement ? returnSelectElement.value : '';

          // Hi·ªÉn th·ªã n·∫øu kh√¥ng c√≥ return status (r·ªóng)
          row.style.display = (returnStatus === '' || !returnStatus) ? '' : 'none';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'return-all':
        // Hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng
        rows.forEach(row => {
          row.style.display = '';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      // Th√™m x·ª≠ l√Ω cho c√°c tr∆∞·ªùng h·ª£p shipping status (gi·ªØ nguy√™n ƒë·ªÉ t∆∞∆°ng th√≠ch)
      case 'shipping-pending':
      case 'shipping-transit':
      case 'shipping-delivered':
      case 'shipping-failed':
      case 'shipping-returned':
        // L·∫•y tr·∫°ng th√°i v·∫≠n chuy·ªÉn c·∫ßn l·ªçc
        const shippingStatusToFilter = sortType.replace('shipping-', '');
        // L·ªçc c√°c ƒë∆°n h√†ng theo tr·∫°ng th√°i v·∫≠n chuy·ªÉn
        rows.forEach(row => {
          const badgeElement = row.querySelectorAll('td')[7].querySelector('.badge');
          const shippingStatus = badgeElement ? badgeElement.className : '';

          // Ki·ªÉm tra xem tr·∫°ng th√°i c√≥ kh·ªõp kh√¥ng
          let shouldDisplay = false;
          if (shippingStatusToFilter === 'pending' && shippingStatus.includes('badge-secondary')) {
            shouldDisplay = true;
          } else if (shippingStatusToFilter === 'transit' && shippingStatus.includes('badge-primary')) {
            shouldDisplay = true;
          } else if (shippingStatusToFilter === 'delivered' && shippingStatus.includes('badge-success')) {
            shouldDisplay = true;
          } else if (shippingStatusToFilter === 'failed' && shippingStatus.includes('badge-danger')) {
            shouldDisplay = true;
          } else if (shippingStatusToFilter === 'returned' && shippingStatus.includes('badge-warning')) {
            shouldDisplay = true;
          }

          row.style.display = shouldDisplay ? '' : 'none';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'shipping-all':
        // Hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng
        rows.forEach(row => {
          row.style.display = '';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      // Th√™m x·ª≠ l√Ω cho c√°c tr∆∞·ªùng h·ª£p order status
      case 'status-pending':
      case 'status-confirmed':
      case 'status-shipping':
      case 'status-success':
      case 'status-failed':
      case 'status-cancelled':
      case 'status-return':
        // L·∫•y tr·∫°ng th√°i ƒë∆°n h√†ng c·∫ßn l·ªçc
        const statusToFilter = sortType.replace('status-', '').toUpperCase();
        // L·ªçc c√°c ƒë∆°n h√†ng theo tr·∫°ng th√°i
        rows.forEach(row => {
          const selectElement = row.querySelectorAll('td')[8].querySelector('select');
          const currentStatus = selectElement ? selectElement.getAttribute('data-current-status') : '';
          row.style.display = (currentStatus === statusToFilter) ? '' : 'none';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'status-all':
        // Hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng
        rows.forEach(row => {
          row.style.display = '';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'payment-method-cod':
      case 'payment-method-bank':
      case 'payment-method-vnpay':
      case 'payment-method-momo':
      case 'payment-method-zalopay':
        // L·∫•y ph∆∞∆°ng th·ª©c thanh to√°n c·∫ßn l·ªçc
        const paymentMethodToFilter = sortType.replace('payment-method-', '').toUpperCase();
        const methodMap = {
          'COD': 'COD',
          'BANK': 'BANK_TRANSFER',
          'VNPAY': 'VNPAY',
          'MOMO': 'MOMO',
          'ZALOPAY': 'ZALOPAY'
        };
        const methodToFilter = methodMap[paymentMethodToFilter] || paymentMethodToFilter;

        // L·ªçc c√°c ƒë∆°n h√†ng theo ph∆∞∆°ng th·ª©c thanh to√°n
        rows.forEach(row => {
          const paymentMethod = row.querySelectorAll('td')[9].textContent.trim();
          row.style.display = paymentMethod.includes(methodToFilter) ? '' : 'none';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'payment-method-all':
        // Hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng
        rows.forEach(row => {
          row.style.display = '';
        });
        return; // Kh√¥ng c·∫ßn s·∫Øp x·∫øp l·∫°i

      case 'update-asc':
        rows.sort((a, b) => {
          const aValue = new Date(a.querySelectorAll('td')[9].textContent);
          const bValue = new Date(b.querySelectorAll('td')[9].textContent);
          return aValue - bValue;
        });
        break;

      case 'update-desc':
        rows.sort((a, b) => {
          const aValue = new Date(a.querySelectorAll('td')[9].textContent);
          const bValue = new Date(b.querySelectorAll('td')[9].textContent);
          return bValue - aValue;
        });
        break;
    }

    // X√≥a c√°c h√†ng hi·ªán t·∫°i
    while (tbody.firstChild) {
      tbody.removeChild(tbody.firstChild);
    }

    // Th√™m l·∫°i c√°c h√†ng ƒë√£ s·∫Øp x·∫øp
    rows.forEach(row => {
      if (row.style.display !== 'none') {
        tbody.appendChild(row);
      }
    });

    // Th√¥ng b√°o ƒë√£ s·∫Øp x·∫øp xong
    if (window.antd && window.antd.message) {
      window.antd.message.success('ƒê√£ s·∫Øp x·∫øp d·ªØ li·ªáu');
    }
  }
</script>
<script>
  async function loadOrders() {
    try {
      // Fetch orders from admin API
      const res = await fetch('/api/orders/admin', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message);

      const orders = data.orders;
      const tbody = document.getElementById('orders-list');
      tbody.innerHTML = ''; // Clear c≈©

      // Fetch total orders count from pagination API
      try {
        const paginationRes = await fetch('/api/orders', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const paginationData = await paginationRes.json();

        if (paginationData && paginationData.pagination && paginationData.pagination.totalOrders) {
          document.getElementById('total-orders').textContent = paginationData.pagination.totalOrders;

          // Update showing info in table footer
          const showingInfo = document.getElementById('orders-showing-info');
          if (showingInfo) {
            const start = 1;
            const end = Math.min(orders.length, 10);
            showingInfo.textContent = `Hi·ªÉn th·ªã ${start}-${end} tr√™n t·ªïng s·ªë ${paginationData.pagination.totalOrders} ƒë∆°n h√†ng`;
          }
        }
      } catch (paginationErr) {
      }

      // Fetch order status counts
      try {
        const statusRes = await fetch('/api/orders/count', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const statusData = await statusRes.json();

        if (Array.isArray(statusData)) {
          // Update order status counts
          const pendingOrders = statusData.find(item => item.status === 'PENDING')?.count || 0;
          const shippingOrders = statusData.find(item => item.status === 'SHIPPING')?.count || 0;
          const cancelledOrders = statusData.find(item => item.status === 'CANCELLED')?.count || 0;
          const returnOrders = statusData.find(item => item.status === 'RETURN')?.count || 0;

          document.getElementById('pending-orders').textContent = pendingOrders;
          document.getElementById('shipping-orders').textContent = shippingOrders;
          document.getElementById('cancel-orders').textContent = cancelledOrders;
          document.getElementById('return-orders').textContent = returnOrders;
        }
      } catch (statusErr) {
      }

      orders.forEach(order => {
        const tr = document.createElement('tr');

        // Get payment info from the payment array
        const paymentInfo = order.payment && order.payment.length > 0 ? order.payment[0] : {};
        const paymentStatus = paymentInfo.status || order.payment_status || 'PENDING';
        const paymentMethod = paymentInfo.method || order.payment_method || 'N/A';

        tr.innerHTML = `
     
        <td class="order-id">${order.order_hash}</td>
        <td>${formatDate(order.created_at)}</td>
        <td>${order.order_name_new || order.order_name_old || order.user_name}</td>
        <td><span class="status ${mapPaymentStatusClass(paymentStatus)}">${mapPaymentStatus(paymentStatus)}</span></td>
        <td>${order.item_count} s·∫£n ph·∫©m</td>
        <td>${formatPrice(order.order_total_final)} ƒë</td>
        <td>
          ${mapReturnStatus(order)}
        </td>
        <td>
          <select class="order-status-select" data-order-id="${order.order_id}" data-current-status="${order.current_status}" onchange="confirmStatusChange(this)">
            <option value="PENDING" ${order.current_status === 'PENDING' ? 'selected' : ''} ${order.current_status !== 'PENDING' ? 'disabled' : ''}>Ch·ªù x√°c nh·∫≠n</option>
            <option value="CONFIRMED" ${order.current_status === 'CONFIRMED' ? 'selected' : ''} ${(order.current_status !== 'PENDING' && order.current_status !== 'CONFIRMED') ? 'disabled' : ''}>ƒê√£ x√°c nh·∫≠n</option>
            <option value="SHIPPING" ${order.current_status === 'SHIPPING' ? 'selected' : ''} ${(order.current_status !== 'CONFIRMED' && order.current_status !== 'SHIPPING') ? 'disabled' : ''}>ƒêang giao</option>
            <option value="SUCCESS" ${order.current_status === 'SUCCESS' ? 'selected' : ''} ${(order.current_status !== 'SHIPPING' && order.current_status !== 'SUCCESS') ? 'disabled' : ''}>Giao h√†ng th√†nh c√¥ng</option>
            <option value="FAILED" ${order.current_status === 'FAILED' ? 'selected' : ''}>Th·∫•t b·∫°i</option>
            <option value="CANCELLED" ${order.current_status === 'CANCELLED' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
            <option value="RETURN" ${order.current_status === 'RETURN' ? 'selected' : ''}>ƒê√£ ho√†n tr·∫£</option>
          </select>
        </td>
        <td>${paymentMethod}</td>
        <td>
          <div class="actions">
            <a href="/dashboard/orders/detail/${order.order_id}" class="action-btn view-btn" title="Xem chi ti·∫øt"><i class="fas fa-pencil"></i></a>
          
          </div>
        </td>
      `;
        tbody.appendChild(tr);
      });
    } catch (err) {
    }
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return `${d.getHours()}:${d.getMinutes()}:${d.getSeconds()} ${d.getDate()}-${d.getMonth() + 1}-${d.getFullYear()}`;
  }

  function formatPrice(price) {
    const numeric = parseFloat(price);
    const integerPart = Math.floor(numeric);
    return integerPart.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function mapStatus(status) {
    switch (status) {
      case 'PENDING': return 'Ch·ªù x√°c nh·∫≠n';
      case 'CONFIRMED': return 'ƒê√£ x√°c nh·∫≠n';
      case 'SHIPPING': return 'ƒêang giao';
      case 'SUCCESS': return 'Giao h√†ng th√†nh c√¥ng';
      case 'FAILED': return 'Th·∫•t b·∫°i';
      case 'CANCELLED': return 'ƒê√£ h·ªßy';
      case 'RETURN': return 'ƒêang ho√†n tr·∫£';
      case 'REFUND': return 'Ho√†n ti·ªÅn';
      default: return status;
    }
  }

  function mapPaymentStatus(status) {
    switch (status) {
      case 'PENDING': return 'Ch·ªù thanh to√°n';
      case 'SUCCESS': return 'ƒê√£ thanh to√°n';
      case 'FAILED': return 'Thanh to√°n th·∫•t b·∫°i';
      case 'REFUNDED': return 'ƒê√£ ho√†n ti·ªÅn';
      default: return status || 'Ch·ªù thanh to√°n';
    }
  }

  function mapPaymentStatusClass(status) {
    switch (status) {
      case 'PENDING': return 'pending';
      case 'SUCCESS': return 'paid';
      case 'FAILED': return 'failed';
      case 'REFUNDED': return 'refunded';
      default: return 'pending';
    }
  }

  function mapShippingStatus(status) {
    switch (status) {
      case 'pending': return 'Ch·ªù l·∫•y h√†ng';
      case 'picking_up': return 'ƒêang ƒëi l·∫•y h√†ng';
      case 'picked_up': return 'ƒê√£ l·∫•y h√†ng';
      case 'in_transit': return 'ƒêang v·∫≠n chuy·ªÉn';
      case 'delivered': return 'ƒê√£ giao h√†ng';
      case 'delivery_failed': return 'Giao h√†ng th·∫•t b·∫°i';
      case 'returning': return 'ƒêang ho√†n tr·∫£';
      case 'returned': return 'ƒê√£ ho√†n tr·∫£';
      case 'canceled': return 'ƒê√£ h·ªßy';
      default: return status || 'Ch·ªù l·∫•y h√†ng';
    }
  }

  function mapShippingStatusClass(status) {
    switch (status) {
      case 'pending': return 'badge-secondary';
      case 'picking_up': return 'badge-info';
      case 'picked_up': return 'badge-primary';
      case 'in_transit': return 'badge-primary';
      case 'delivered': return 'badge-success';
      case 'delivery_failed': return 'badge-danger';
      case 'returning': return 'badge-warning';
      case 'returned': return 'badge-warning';
      case 'canceled': return 'badge-dark';
      default: return 'badge-secondary';
    }
  }

  function mapShippingStatusIcon(status) {
    switch (status) {
      case 'pending': return 'fa-clock';
      case 'picking_up': return 'fa-people-carry';
      case 'picked_up': return 'fa-box';
      case 'in_transit': return 'fa-truck';
      case 'delivered': return 'fa-check-circle';
      case 'delivery_failed': return 'fa-times-circle';
      case 'returning': return 'fa-undo';
      case 'returned': return 'fa-box-open';
      case 'canceled': return 'fa-ban';
      default: return 'fa-clock';
    }
  }

  function mapReturnStatus(order) {
    // Ch·ªâ cho ph√©p thay ƒë·ªïi return status n·∫øu current_status l√† 'RETURN'
    if (order.current_status !== 'RETURN') {
      return '<span class="badge badge-secondary">Kh√¥ng c√≥ ho√†n tr·∫£</span>';
    }

    // L·∫•y th√¥ng tin return status theo th·ª© t·ª± ∆∞u ti√™n
    let currentReturnStatus = null;

    // 1. Ki·ªÉm tra returnInfo.return_status (t·ª´ c·∫£ admin API v√† hash API)
    if (order.returnInfo && order.returnInfo.return_status) {
      currentReturnStatus = order.returnInfo.return_status;
    }
    // 2. Ki·ªÉm tra return_status tr·ª±c ti·∫øp (fallback)
    else if (order.return_status) {
      currentReturnStatus = order.return_status;
    }
    // 3. Ki·ªÉm tra order_returns array (cho t∆∞∆°ng th√≠ch)
    else if (order.order_returns && order.order_returns.length > 0) {
      currentReturnStatus = order.order_returns[order.order_returns.length - 1].status;
    }
    // 4. M·∫∑c ƒë·ªãnh l√† PENDING n·∫øu ƒë∆°n h√†ng ·ªü tr·∫°ng th√°i RETURN nh∆∞ng ch∆∞a c√≥ return status
    else {
      currentReturnStatus = 'PENDING';
    }

    // Logic cho ph√©p chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i return
    const canTransitionTo = (fromStatus, toStatus) => {
      const transitions = {
        'PENDING': ['APPROVED', 'REJECTED'],
        'APPROVED': ['CANCEL_CONFIRMED', 'REJECTED'],
        'CANCEL_CONFIRMED': ['CANCELLED'],
        'REJECTED': ['PENDING'], // Cho ph√©p t·∫°o l·∫°i y√™u c·∫ßu
        'CANCELLED': [] // Tr·∫°ng th√°i cu·ªëi, kh√¥ng th·ªÉ chuy·ªÉn
      };
      return transitions[fromStatus] ? transitions[fromStatus].includes(toStatus) : true;
    };

    // T·∫°o select dropdown cho return status (ch·ªâ khi current_status = 'RETURN')
    return `
      <select class="return-status-select" data-order-id="${order.order_id}" data-current-return-status="${currentReturnStatus || ''}" onchange="confirmReturnStatusChange(this)">
        <option value="" ${!currentReturnStatus ? 'selected' : ''}>Kh√¥ng c√≥ ho√†n tr·∫£</option>
        <option value="PENDING" ${currentReturnStatus === 'PENDING' ? 'selected' : ''} ${currentReturnStatus && !canTransitionTo(currentReturnStatus, 'PENDING') && currentReturnStatus !== 'PENDING' ? 'disabled' : ''}>ƒêang ch·ªù x·ª≠ l√Ω </option>
        <option value="APPROVED" ${currentReturnStatus === 'APPROVED' ? 'selected' : ''} ${currentReturnStatus && !canTransitionTo(currentReturnStatus, 'APPROVED') && currentReturnStatus !== 'APPROVED' ? 'disabled' : ''}>ƒê√£ x·ª≠ l√Ω</option>
        <option value="CANCEL_CONFIRMED" ${currentReturnStatus === 'CANCEL_CONFIRMED' ? 'selected' : ''} ${currentReturnStatus && !canTransitionTo(currentReturnStatus, 'CANCEL_CONFIRMED') && currentReturnStatus !== 'CANCEL_CONFIRMED' ? 'disabled' : ''}>X√°c nh·∫≠n ho√†n tr·∫£</option>
        <option value="CANCELLED" ${currentReturnStatus === 'CANCELLED' ? 'selected' : ''} ${currentReturnStatus && !canTransitionTo(currentReturnStatus, 'CANCELLED') && currentReturnStatus !== 'CANCELLED' ? 'disabled' : ''}>ƒê√£ ho√†n tr·∫£ ho√†n t·∫•t</option>
        <option value="REJECTED" ${currentReturnStatus === 'REJECTED' ? 'selected' : ''} ${currentReturnStatus && !canTransitionTo(currentReturnStatus, 'REJECTED') && currentReturnStatus !== 'REJECTED' ? 'disabled' : ''}>T·ª´ ch·ªëi tr·∫£ h√†ng</option>
      </select>
    `;
  }

  function showStatusDropdown(element) {
    // X√≥a h√†m n√†y v√¨ kh√¥ng c·∫ßn thi·∫øt n·ªØa
  }

  function confirmStatusChange(selectElement) {
    const orderId = selectElement.getAttribute('data-order-id');
    const previousStatus = selectElement.getAttribute('data-current-status');
    const newStatus = selectElement.value;

    // N·∫øu tr·∫°ng th√°i kh√¥ng thay ƒë·ªïi, kh√¥ng l√†m g√¨ c·∫£
    if (previousStatus === newStatus) {
      return;
    }

    // ƒê·ªãnh nghƒ©a th·ª© t·ª± c√°c tr·∫°ng th√°i
    const statusOrder = {
      'PENDING': 1,
      'CONFIRMED': 2,
      'SHIPPING': 3,
      'SUCCESS': 4,
      'FAILED': 5,
      'CANCELLED': 6
    };

    // Ki·ªÉm tra xem c√≥ ƒëang c·ªë g·∫Øng l√πi step kh√¥ng
    // Cho ph√©p chuy·ªÉn sang FAILED ho·∫∑c CANCELLED t·ª´ b·∫•t k·ª≥ tr·∫°ng th√°i n√†o
    if (newStatus !== 'FAILED' && newStatus !== 'CANCELLED' &&
      statusOrder[newStatus] < statusOrder[previousStatus]) {
      // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
      if (window.antd && window.antd.notification) {
        window.antd.notification.error({
          message: 'Kh√¥ng ƒë∆∞·ª£c ph√©p',
          description: 'Kh√¥ng th·ªÉ l√πi tr·∫°ng th√°i ƒë∆°n h√†ng v·ªÅ b∆∞·ªõc tr∆∞·ªõc ƒë√≥',
          placement: 'topRight'
        });
      } else {
        alert('Kh√¥ng th·ªÉ l√πi tr·∫°ng th√°i ƒë∆°n h√†ng v·ªÅ b∆∞·ªõc tr∆∞·ªõc ƒë√≥');
      }

      // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
      selectElement.value = previousStatus;
      return;
    }

    // L·∫•y t√™n tr·∫°ng th√°i ƒë·ªÉ hi·ªÉn th·ªã
    const previousStatusText = mapStatus(previousStatus);
    const newStatusText = mapStatus(newStatus);

    // S·ª≠ d·ª•ng Ant Design Modal ƒë·ªÉ x√°c nh·∫≠n
    if (window.antd && window.antd.Modal) {
      window.antd.Modal.confirm({
        title: 'X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i',
        content: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thay ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng t·ª´ "${previousStatusText}" sang "${newStatusText}"?`,
        okText: 'X√°c nh·∫≠n',
        cancelText: 'H·ªßy',
        onOk: () => updateOrderStatus(orderId, newStatus),
        onCancel: () => {
          // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
          selectElement.value = previousStatus;
        }
      });
    } else {
      // Fallback n·∫øu kh√¥ng c√≥ Ant Design
      if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thay ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng t·ª´ "${previousStatusText}" sang "${newStatusText}"?`)) {
        updateOrderStatus(orderId, newStatus);
      } else {
        // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
        selectElement.value = previousStatus;
      }
    }
  }

  function confirmReturnStatusChange(selectElement) {
    const orderId = selectElement.getAttribute('data-order-id');
    const previousReturnStatus = selectElement.getAttribute('data-current-return-status');
    const newReturnStatus = selectElement.value;

    // N·∫øu tr·∫°ng th√°i kh√¥ng thay ƒë·ªïi, kh√¥ng l√†m g√¨ c·∫£
    if (previousReturnStatus === newReturnStatus) {
      return;
    }

    // Logic cho ph√©p chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i return (gi·ªëng nh∆∞ trong mapReturnStatus)
    const canTransitionTo = (fromStatus, toStatus) => {
      const transitions = {
        'PENDING': ['APPROVED', 'REJECTED'],
        'APPROVED': ['CANCEL_CONFIRMED', 'REJECTED'],
        'CANCEL_CONFIRMED': ['CANCELLED'],
        'REJECTED': ['PENDING'], // Cho ph√©p t·∫°o l·∫°i y√™u c·∫ßu
        'CANCELLED': [], // Tr·∫°ng th√°i cu·ªëi, kh√¥ng th·ªÉ chuy·ªÉn
        '': ['PENDING'] // T·ª´ kh√¥ng c√≥ ho√†n tr·∫£ c√≥ th·ªÉ chuy·ªÉn th√†nh PENDING
      };
      return transitions[fromStatus] ? transitions[fromStatus].includes(toStatus) : true;
    };

    // Ki·ªÉm tra xem c√≥ ƒë∆∞·ª£c ph√©p chuy·ªÉn ƒë·ªïi kh√¥ng
    if (!canTransitionTo(previousReturnStatus, newReturnStatus)) {
      if (window.antd && window.antd.notification) {
        window.antd.notification.error({
          message: 'Kh√¥ng ƒë∆∞·ª£c ph√©p',
          description: `Kh√¥ng th·ªÉ chuy·ªÉn tr·∫°ng th√°i t·ª´ "${mapReturnStatusText(previousReturnStatus)}" sang "${mapReturnStatusText(newReturnStatus)}"`,
          placement: 'topRight'
        });
      } else {
        alert(`Kh√¥ng th·ªÉ chuy·ªÉn tr·∫°ng th√°i t·ª´ "${mapReturnStatusText(previousReturnStatus)}" sang "${mapReturnStatusText(newReturnStatus)}"`);
      }

      // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
      selectElement.value = previousReturnStatus;
      return;
    }

    // L·∫•y t√™n tr·∫°ng th√°i ƒë·ªÉ hi·ªÉn th·ªã
    const previousStatusText = mapReturnStatusText(previousReturnStatus);
    const newStatusText = mapReturnStatusText(newReturnStatus);

    // S·ª≠ d·ª•ng Ant Design Modal ƒë·ªÉ x√°c nh·∫≠n
    if (window.antd && window.antd.Modal) {
      window.antd.Modal.confirm({
        title: 'X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i ho√†n tr·∫£',
        content: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thay ƒë·ªïi tr·∫°ng th√°i ho√†n tr·∫£ t·ª´ "${previousStatusText}" sang "${newStatusText}"?`,
        okText: 'X√°c nh·∫≠n',
        cancelText: 'H·ªßy',
        onOk: () => {
          // C·∫≠p nh·∫≠t data attribute ngay l·∫≠p t·ª©c ƒë·ªÉ tr√°nh conflict
          selectElement.setAttribute('data-current-return-status', newReturnStatus);
          updateReturnStatus(orderId, newReturnStatus);
        },
        onCancel: () => {
          // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
          selectElement.value = previousReturnStatus;
        }
      });
    } else {
      // Fallback n·∫øu kh√¥ng c√≥ Ant Design
      if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thay ƒë·ªïi tr·∫°ng th√°i ho√†n tr·∫£ t·ª´ "${previousStatusText}" sang "${newStatusText}"?`)) {
        selectElement.setAttribute('data-current-return-status', newReturnStatus);
        updateReturnStatus(orderId, newReturnStatus);
      } else {
        // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
        selectElement.value = previousReturnStatus;
      }
    }
  }

  function mapReturnStatusText(status) {
    switch (status) {
      case '': return 'Kh√¥ng c√≥ ho√†n tr·∫£';
      case 'PENDING': return 'ƒêang ch·ªù x·ª≠ l√Ω';
      case 'APPROVED': return 'ƒê√£ duy·ªát tr·∫£ h√†ng';
      case 'CANCEL_CONFIRMED': return 'X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng';
      case 'CANCELLED': return 'ƒê√£ h·ªßy ho√†n t·∫•t';
      case 'REJECTED': return 'T·ª´ ch·ªëi tr·∫£ h√†ng';
      default: return status;
    }
  }

  async function updateOrderStatus(orderId, newStatus) {
    try {
      const response = await fetch(`/api/orders/${orderId}/status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ new_status: newStatus })
      });

      const data = await response.json();

      if (data.success) {
        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng s·ª≠ d·ª•ng Ant Design
        if (window.antd && window.antd.notification) {
          window.antd.notification.success({
            message: 'Th√†nh c√¥ng',
            description: data.message,
            placement: 'topRight'
          });
        } else {
          // Fallback n·∫øu kh√¥ng c√≥ Ant Design
          alert(data.message);
        }

        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë∆°n h√†ng
        loadOrders();
      } else {
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        if (window.antd && window.antd.notification) {
          window.antd.notification.error({
            message: 'L·ªói',
            description: data.message,
            placement: 'topRight'
          });
        } else {
          alert('L·ªói: ' + data.message);
        }

        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë∆°n h√†ng ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã tr·∫°ng th√°i ch√≠nh x√°c
        loadOrders();
      }
    } catch (error) {
      if (window.antd && window.antd.notification) {
        window.antd.notification.error({
          message: 'L·ªói',
          description: 'ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng',
          placement: 'topRight'
        });
      } else {
        alert('ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng');
      }

      // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë∆°n h√†ng ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã tr·∫°ng th√°i ch√≠nh x√°c
      loadOrders();
    }
  }

  async function updateReturnStatus(orderId, newReturnStatus) {
    try {
      // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t return status
      const response = await fetch(`/api/orders/${orderId}/return-status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ return_status: newReturnStatus })
      });

      const data = await response.json();

      if (data.success) {
        // N·∫øu tr·∫°ng th√°i ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh CANCEL_CONFIRMED, g·ª≠i email xin l·ªói k√®m voucher
        if (newReturnStatus === 'CANCEL_CONFIRMED') {
          try {
            // G·ªçi API ƒë·ªÉ g·ª≠i email xin l·ªói k√®m voucher
            const emailResponse = await fetch(`/api/orders/${orderId}/send-apology-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              }
            });

            const emailData = await emailResponse.json();

            if (emailData.success) {
              // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng v·ªõi th√¥ng tin voucher chi ti·∫øt
              const voucherInfo = emailData.data;
              const voucherMessage = `ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i v√† g·ª≠i email xin l·ªói k√®m voucher gi·∫£m gi√° ${voucherInfo.discountPercent}% cho kh√°ch h√†ng.\n\nüé´ M√£ voucher: ${voucherInfo.voucherCode}\nüìÖ H·∫°n s·ª≠ d·ª•ng: ${voucherInfo.expiryDate}\nüìß G·ª≠i ƒë·∫øn: ${voucherInfo.email}`;

              if (window.antd && window.antd.notification) {
                window.antd.notification.success({
                  message: 'Th√†nh c√¥ng',
                  description: voucherMessage,
                  placement: 'topRight',
                  duration: 8
                });
              } else {
                alert(voucherMessage);
              }
            } else {
              // N·∫øu g·ª≠i email th·∫•t b·∫°i, v·∫´n th√¥ng b√°o c·∫≠p nh·∫≠t th√†nh c√¥ng nh∆∞ng c√≥ l·ªói email
              if (window.antd && window.antd.notification) {
                window.antd.notification.warning({
                  message: 'C·∫≠p nh·∫≠t th√†nh c√¥ng',
                  description: 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i nh∆∞ng kh√¥ng th·ªÉ g·ª≠i email xin l·ªói: ' + (emailData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'),
                  placement: 'topRight',
                  duration: 5
                });
              } else {
                alert('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i nh∆∞ng kh√¥ng th·ªÉ g·ª≠i email xin l·ªói: ' + (emailData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
              }
            }
          } catch (emailError) {
            // V·∫´n th√¥ng b√°o c·∫≠p nh·∫≠t th√†nh c√¥ng nh∆∞ng c√≥ l·ªói email
            if (window.antd && window.antd.notification) {
              window.antd.notification.warning({
                message: 'C·∫≠p nh·∫≠t th√†nh c√¥ng',
                description: 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i nh∆∞ng c√≥ l·ªói khi g·ª≠i email xin l·ªói',
                placement: 'topRight'
              });
            } else {
              alert('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i nh∆∞ng c√≥ l·ªói khi g·ª≠i email xin l·ªói');
            }
          }
        } else {
          // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng b√¨nh th∆∞·ªùng cho c√°c tr·∫°ng th√°i kh√°c
          if (window.antd && window.antd.notification) {
            window.antd.notification.success({
              message: 'Th√†nh c√¥ng',
              description: data.message || 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n tr·∫£ th√†nh c√¥ng',
              placement: 'topRight'
            });
          } else {
            alert(data.message || 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n tr·∫£ th√†nh c√¥ng');
          }
        }

        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë∆°n h√†ng
        loadOrders();
      } else {
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        if (window.antd && window.antd.notification) {
          window.antd.notification.error({
            message: 'L·ªói',
            description: data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n tr·∫£',
            placement: 'topRight'
          });
        } else {
          alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n tr·∫£'));
        }

        // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë∆°n h√†ng ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã tr·∫°ng th√°i ch√≠nh x√°c
        loadOrders();
      }
    } catch (error) {
      if (window.antd && window.antd.notification) {
        window.antd.notification.error({
          message: 'L·ªói',
          description: 'ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n tr·∫£',
          placement: 'topRight'
        });
      } else {
        alert('ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i ho√†n tr·∫£');
      }

      // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë∆°n h√†ng ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã tr·∫°ng th√°i ch√≠nh x√°c
      loadOrders();
    }
  }
</script>