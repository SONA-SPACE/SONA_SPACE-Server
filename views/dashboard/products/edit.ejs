<!-- Trang S·ª≠a S·∫£n ph·∫©m -->

<!-- Ti√™u ƒë·ªÅ -->
<div class="dashboard-header-row">
  <h2 class="dashboard-title">S·ª≠a s·∫£n ph·∫©m</h2>
</div>

<!-- Container ch√≠nh - chia 2 c·ªôt -->
<div class="add-product-container">
  <!-- C·ªôt tr√°i: Form th√¥ng tin s·∫£n ph·∫©m -->
  <div class="product-form-column">
    <!-- ===== Th√¥ng tin s·∫£n ph·∫©m c∆° b·∫£n ===== -->
    <div class="form-section">
      <h3 class="section-title">Th√¥ng tin s·∫£n ph·∫©m</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="productName">T√™n s·∫£n ph·∫©m</label>
          <input type="text" id="productName" class="form-control" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" />
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label for="productSlug">Slug</label>
          <input type="text" id="productSlug" class="form-control" placeholder="C√≥ th·ªÉ t·ª± t·∫°o n·∫øu b·ªè tr·ªëng" />
        </div>
        <div class="form-group">
          <label for="productStatus">Tr·∫°ng th√°i</label>
          <div class="select-wrapper">
            <select id="productStatus" class="form-control">
              <option value="">Ch·ªçn tr·∫°ng th√°i</option>
              <option value="1">Hi·ªÉn th·ªã</option>
              <option value="0">·∫®n</option>
            </select>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="invalid-feedback"></div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="productCategory">Danh m·ª•c</label>
          <div class="select-wrapper">
            <select id="productCategory" class="form-control"></select>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label for="productRooms">Danh m·ª•c ph√≤ng</label>
          <div class="select-wrapper">
            <select id="productRooms" class="form-control"></select>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="invalid-feedback"></div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label for="productDescription">M√¥ t·∫£</label>
          <textarea id="productDescription" class="form-control" rows="5" placeholder="Nh·∫≠p m√¥ t·∫£"></textarea>
          <div class="invalid-feedback"></div>
        </div>
      </div>
    </div>

    <!-- ===== Th√¥ng tin b·ªï sung ===== -->
    <div class="form-section">
      <div class="variant-header">
        <h3 class="section-title">Th√¥ng tin b·ªï sung</h3>
        <button type="button" class="btn btn-add-attribute">
          <i class="fas fa-plus"></i> Th√™m thu·ªôc t√≠nh
        </button>
      </div>
      <div id="newAttributesContainer"></div>
      <div id="dynamicAttributesContainer"></div>
    </div>
  </div>

  <div class="right-column">
    <!-- ===== ·∫¢nh ch√≠nh ===== -->
    <div class="form-section">
      <h3 class="section-title">·∫¢nh ch√≠nh s·∫£n ph·∫©m</h3>
      <div class="main-image-upload" id="mainImageUpload" style="display: none">
        <div class="upload-zone">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>K√©o th·∫£ ho·∫∑c click ƒë·ªÉ t·∫£i ·∫£nh</p>
          <p class="upload-hint">ƒê·ªãnh d·∫°ng: JPG, PNG (T·ªëi ƒëa 5MB)</p>
          <input type="file" hidden accept="image/*" />
        </div>
      </div>
      <div class="main-image-preview" style="display: none">
        <img src="" alt="Preview" />
        <button class="remove-image"><i class="fas fa-times"></i></button>
      </div>
    </div>

    <!-- ===== Bi·∫øn th·ªÉ ===== -->
    <div class="form-section">
      <div class="variant-header">
        <h3 class="section-title">Bi·∫øn th·ªÉ s·∫£n ph·∫©m</h3>
        <button type="button" class="btn btn-add-variant">
          <i class="fas fa-plus"></i> Th√™m bi·∫øn th·ªÉ
        </button>
      </div>
      <div id="variantsList">
        <!-- Template Bi·∫øn th·ªÉ -->
        <div class="variant-item" style="display: none" id="variantTemplate">
          <div class="variant-header">
            <h4 class="variant-title">Bi·∫øn th·ªÉ m·ªõi</h4>
            <div class="variant-actions">
              <button class="btn-toggle-variant">
                <i class="fas fa-chevron-down"></i>
              </button>
              <button class="btn-remove-variant">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          <div class="variant-content">
            <div class="form-row">
              <div class="form-group">
                <label>T√™n m√†u</label>
                <div class="select-wrapper">
                  <select class="form-control variant-color">
                    <option value="">Ch·ªçn m√†u</option>
                  </select>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label>Slug</label>
                <input type="text" class="form-control variant-slug" placeholder="T·ª± ƒë·ªông t·∫°o n·∫øu ƒë·ªÉ tr·ªëng" />
                <div class="invalid-feedback"></div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>S·ªë l∆∞·ª£ng</label>
                <input type="number" class="form-control variant-quantity" min="0" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng" />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label>Gi√° g·ªëc</label>
                <input type="number" class="form-control variant-price" min="0" placeholder="Nh·∫≠p gi√° g·ªëc" />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label>Gi√° gi·∫£m</label>
                <input type="number" class="form-control variant-sale-price" min="0" placeholder="Nh·∫≠p gi√° gi·∫£m" />
                <div class="invalid-feedback"></div>
              </div>
            </div>

            <div class="variant-images">
              <label>H√¨nh ·∫£nh bi·∫øn th·ªÉ</label>
              <div class="variant-image-grid"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="form-actions">
  <button type="button" class="btn btn-cancel">H·ªßy</button>
  <button type="button" class="btn btn-save">L∆∞u</button>
</div>

<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050"></div>


<script>
  // Global counter for new attributes
  let newAttributeCounter = 0; // Initialize the counter

  function showFieldError(element, message) {
    if (!element) return;
    element.classList.add("is-invalid");
    let feedbackEl = element.nextElementSibling; // Th·ª≠ t√¨m feedback l√† anh em li·ªÅn k·ªÅ

    // N·∫øu kh√¥ng ph·∫£i anh em li·ªÅn k·ªÅ, t√¨m trong ph·∫ßn t·ª≠ cha chung (.form-infor ho·∫∑c .form-group)
    if (!feedbackEl || !feedbackEl.classList.contains("invalid-feedback")) {
      const parentContainer = element.closest(".form-infor") || element.closest(".form-group");
      if (parentContainer) {
        feedbackEl = parentContainer.querySelector(".invalid-feedback");
      }
    }

    // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho variant-image-grid v√† mainImageUpload n·∫øu feedback n·∫±m ngo√†i
    if (!feedbackEl && (element.classList.contains("variant-image-grid") || element.id === "mainImageUpload")) {
      let existingSiblingFeedback = element.nextElementSibling;
      if (existingSiblingFeedback && existingSiblingFeedback.classList.contains("invalid-feedback")) {
        feedbackEl = existingSiblingFeedback;
      } else {
        feedbackEl = document.createElement("div");
        feedbackEl.className = "invalid-feedback d-block";
        element.parentNode.insertBefore(feedbackEl, element.nextSibling);
      }
    }

    if (feedbackEl) {
      feedbackEl.textContent = message;
      feedbackEl.style.display = "block";
    }
  }

  function clearFieldError(element) {
    if (!element) return;
    element.classList.remove("is-invalid");
    let feedbackEl = element.nextElementSibling;

    if (!feedbackEl || !feedbackEl.classList.contains("invalid-feedback")) {
      const parentContainer = element.closest(".form-infor") || element.closest(".form-group");
      if (parentContainer) {
        feedbackEl = parentContainer.querySelector(".invalid-feedback");
      }
    }

    // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho variant-image-grid v√† mainImageUpload n·∫øu feedback n·∫±m ngo√†i
    if (element.classList.contains("variant-image-grid") || element.id === "mainImageUpload") {
      let existingSiblingFeedback = element.nextElementSibling;
      if (existingSiblingFeedback && existingSiblingFeedback.classList.contains("invalid-feedback")) {
        existingSiblingFeedback.remove();
        return;
      }
    }

    if (feedbackEl) {
      feedbackEl.textContent = "";
      feedbackEl.style.display = "none";
    }
  }

  const API_URL = "http://localhost:3501";
  const slug = window.location.pathname.split("/").pop();
  let globalColors = [];
  let globalMaterials = [];
  let removedImages = [];

  const productNameInput = document.getElementById("productName");
  const productSlugInput = document.getElementById("productSlug");
  const productStatusSelect = document.getElementById("productStatus");
  const productCategorySelect = document.getElementById("productCategory");
  const productRoomsSelect = document.getElementById("productRooms");
  const productDescriptionTextarea = document.getElementById("productDescription");
  const mainImagePreview = document.querySelector(".main-image-preview img");
  const mainImageContainer = document.querySelector(".main-image-preview");
  const mainImageUpload = document.getElementById("mainImageUpload");
  const mainImageUploadInput = mainImageUpload.querySelector('input[type="file"]');
  const variantTemplate = document.getElementById("variantTemplate");
  const variantsList = document.getElementById("variantsList");

  // Helper function for API calls
  async function fetchAPI(endpoint, options = {}) {
    const url = `${API_URL}${endpoint}`;
    try {
      const response = await fetch(url, options);
      const data = await response.json();
      if (!response.ok) {
        console.error("API Error:", data);
        return { success: false, message: data.message || "An API error occurred.", error: data.error, errors: data.errors };
      }
      return { success: true, ...data };
    } catch (error) {
      console.error("Network or parsing error:", error);
      return { success: false, message: "Network error or invalid response.", error: error.message };
    }
  }

  async function loadDynamicAttributes(categoryId, productAttributes = []) {
    const dynamicAttributesContainer = document.getElementById("dynamicAttributesContainer");
    if (!dynamicAttributesContainer) return;

    dynamicAttributesContainer.innerHTML = '';
    if (!categoryId) return;
    try {
      const res = await fetch(`${API_URL}/api/categories/${categoryId}/attributes`);
      if (!res.ok) throw new Error("Could not fetch category attributes");
      const attributesMeta = await res.json();

      attributesMeta.forEach(attrMeta => {
        const valueType = attrMeta.value_type;
        const formGroup = document.createElement("div");
        formGroup.className = "form-infor";

        let inputHtml = '';
        if (valueType === 'material_id') {
          inputHtml = `
                        <div class="select-wrapper">
                            <select id="attr-${attrMeta.attribute_id}" class="form-control dynamic-attribute"
                                    data-attribute-id="${attrMeta.attribute_id}" data-value-type="material_id" ${attrMeta.is_required ? 'required' : ''}>
                                <option value="">Ch·ªçn ch·∫•t li·ªáu</option>
                                ${globalMaterials.map(mat => `<option value="${mat.material_id}">${mat.material_name}</option>`).join('')}
                            </select>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    `;
        } else {
          inputHtml = `
                        <input type="${valueType === 'number' ? 'number' : 'text'}"
                               id="attr-${attrMeta.attribute_id}" class="form-control dynamic-attribute"
                               data-attribute-id="${attrMeta.attribute_id}" data-value-type="${valueType}" ${attrMeta.is_required ? 'required' : ''}
                               placeholder="Nh·∫≠p ${attrMeta.attribute_name.toLowerCase()}" />
                    `;
        }

        formGroup.innerHTML = `
                    <label for="attr-${attrMeta.attribute_id}">${attrMeta.attribute_name} ${attrMeta.is_required ? '<span class="required-asterisk">*</span>' : ''} (${attrMeta.unit || ''})</label>
                    ${inputHtml}
                    <div class="invalid-feedback"></div>
                `;
        dynamicAttributesContainer.appendChild(formGroup);

        const inputElement = formGroup.querySelector(`.dynamic-attribute`);
        if (inputElement) {
          const existingAttr = productAttributes.find(pa => pa.attribute_id === attrMeta.attribute_id);
          if (existingAttr) {
            if (valueType === 'material_id') {
              inputElement.value = existingAttr.material_id || '';
            } else {
              inputElement.value = existingAttr.value ?? '';
            }
          }
          inputElement.addEventListener("input", () => clearFieldError(inputElement));
          inputElement.addEventListener("change", () => clearFieldError(inputElement));
        }
      });
    } catch (error) {
      console.error("L·ªói khi t·∫£i thu·ªôc t√≠nh ƒë·ªông:", error);
      showToast("L·ªói khi t·∫£i th√¥ng tin b·ªï sung cho danh m·ª•c n√†y.", "danger");
    }
  }

  function extractPublicIdFromUrl(url) {
    const matches = url.match(
      /upload\/(?:v\d+\/)?([^\.]+)\.(jpg|jpeg|png|webp|gif)/
    );
    if (!matches || !matches[1]) return null;
    return matches[1];
  }

  mainImageContainer
    .querySelector(".remove-image")
    ?.addEventListener("click", () => {
      const publicId = extractPublicIdFromUrl(mainImagePreview.src);
      if (publicId) {
        removedImages.push(publicId);
        console.log("[REMOVE IMAGE] ƒê√£ ƒë√°nh d·∫•u x√≥a ·∫£nh ch√≠nh:", publicId);
      }
      mainImagePreview.src = "";
      mainImageContainer.style.display = "none";
      mainImageUpload.style.display = "block";
      mainImageUploadInput.value = "";
    });

  mainImageUpload.addEventListener("click", () =>
    mainImageUploadInput.click()
  );

  mainImageUploadInput.addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = function (e) {
        mainImagePreview.src = e.target.result;
        mainImageContainer.style.display = "block";
        mainImageUpload.style.display = "none";
      };
      reader.readAsDataURL(file);
    }
  });

  async function loadProductDetail() {
    try {
      const res = await fetch(`${API_URL}/api/products/admin/${slug}`);
      const data = await res.json();
      const product = data.product;

      productNameInput.value = product.name || "";
      productSlugInput.value = product.slug || "";
      productStatusSelect.value = product.status ?? "";
      productCategorySelect.value = product.category_id ?? "";
      productDescriptionTextarea.value = product.description || "";

      await loadProductSelectBoxes(
        product.category_id,
        data.rooms?.map((r) => r.room_id)
      );

      await loadDynamicAttributes(product.category_id, product.attributes);

      if (product.main_image) {
        mainImagePreview.src = product.main_image;
        mainImageContainer.style.display = "block";
        mainImageUpload.style.display = "none";
      } else {
        mainImagePreview.src = "";
        mainImageContainer.style.display = "none";
        mainImageUpload.style.display = "block";
      }

      variantsList.innerHTML = "";

      product.variants.forEach((variant, idx) => {
        const clone = variantTemplate.cloneNode(true);
        clone.style.display = "block";
        clone.removeAttribute("id");
        clone.setAttribute("data-id", variant.variant_id);
        clone.classList.add("variant-item");

        clone.querySelector(".variant-title").textContent =
          variant.color_name || `Bi·∫øn th·ªÉ ${idx + 1}`;
        const colorSelect = clone.querySelector(".variant-color");
        colorSelect.innerHTML = globalColors
          .map(
            (color) =>
              `<option value="${color.color_id}" ${color.color_id == variant.color_id ? "selected" : ""
              }>${color.color_name}</option>`
          )
          .join("");
        colorSelect.value = variant.color_id;
        clone.querySelector(".variant-slug").value = variant.slug || "";
        clone.querySelector(".variant-quantity").value = variant.quantity ?? 0;
        clone.querySelector(".variant-price").value = variant.price ?? 0;
        clone.querySelector(".variant-sale-price").value =
          variant.price_sale ?? 0;

        clone.variantData = {
          color_id: variant.color_id,
          variant_slug: variant.slug || "",
          quantity: variant.quantity,
          price: variant.price ?? 0,
          price_sale: variant.price_sale ?? 0,
          list_image: Array.isArray(variant.list_image)
            ? variant.list_image
            : [],
        };

        variantsList.appendChild(clone);
        setupVariantEvents(clone);
      });
    } catch (err) {
      console.error("L·ªói load s·∫£n ph·∫©m:", err);
      showToast("Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m", "danger");
    }
  }

  productCategorySelect.addEventListener("change", async () => {
    clearFieldError(productCategorySelect);
    const selectedCategoryId = productCategorySelect.value;
    await loadDynamicAttributes(selectedCategoryId, []);
  });

  async function loadProductSelectBoxes(
    selectedCategoryId,
    selectedRoomIds
  ) {
    try {
      const [categoryRes, roomsRes, colorsRes, materialsRes] =
        await Promise.all([
          fetch(`${API_URL}/api/categories`),
          fetch(`${API_URL}/api/rooms`),
          fetch(`${API_URL}/api/color/filter`),
          fetch(`${API_URL}/api/materials`),
        ]);
      const [categories, rooms, colors, materials] = await Promise.all([
        categoryRes.json(),
        roomsRes.json(),
        colorsRes.json(),
        materialsRes.json(),
      ]);

      globalColors = colors;
      globalMaterials = materials;

      productCategorySelect.innerHTML = categories
        .map(
          (c) =>
            `<option value="${c.category_id}" ${c.category_id == selectedCategoryId ? "selected" : ""
            }>${c.category_name}</option>`
        )
        .join("");

      productRoomsSelect.innerHTML = rooms
        .map(
          (r) =>
            `<option value="${r.room_id}" ${selectedRoomIds?.includes(r.room_id) ? "selected" : ""
            }>${r.room_name}</option>`
        )
        .join("");
    } catch (error) {
      console.error("L·ªói khi t·∫£i select boxes:", error);
      showToast(
        "L·ªói khi t·∫£i th√¥ng tin danh m·ª•c / ph√≤ng / m√†u s·∫Øc / ch·∫•t li·ªáu ",
        "danger"
      );
    }
  }

  function createUploadBox(imageGrid) {
    const uploadBox = document.createElement("div");
    uploadBox.className = "variant-image-item active variant-upload-box";
    uploadBox.innerHTML = `
                <div class="upload-placeholder">
                    <i class="fas fa-plus"></i>
                    <input type="file" hidden accept="image/*" />
                </div>
            `;

    const input = uploadBox.querySelector('input[type="file"]');
    const maxImages = 7;

    uploadBox.addEventListener("click", () => input.click());

    input.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function (event) {
          addLoadedImageBox(event.target.result, imageGrid, uploadBox, file);
        };
        reader.readAsDataURL(file);
      }
    });
    return uploadBox;
  }

  function addLoadedImageBox(imgUrl, imageGrid, uploadBox, file) {
    const loadedBox = document.createElement("div");
    loadedBox.className = "variant-image-item loaded";
    loadedBox.dataset.local = "true";
    loadedBox.dataset.filename = file?.name || "";

    loadedBox.innerHTML = `
                <img src="${imgUrl}" alt="Preview" style="width:80px;margin:5px;">
                <button class="remove-image"><i class="fas fa-times"></i></button>
                <input type="file" hidden />
            `;

    const hiddenInput = loadedBox.querySelector('input[type="file"]');
    if (file) {
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      hiddenInput.files = dataTransfer.files;
    }

    loadedBox
      .querySelector(".remove-image")
      .addEventListener("click", function (ev) {
        ev.stopPropagation();

        if (!file) {
          const publicId = extractPublicIdFromUrl(imgUrl);
          if (publicId) {
            removedImages.push(publicId);
            console.log("[REMOVE IMAGE] ƒê√£ ƒë√°nh d·∫•u x√≥a ·∫£nh bi·∫øn th·ªÉ:", publicId);
          }
        }
        loadedBox.remove();
        // ƒê·∫£m b·∫£o lu√¥n c√≥ m·ªôt √¥ upload n·∫øu s·ªë l∆∞·ª£ng ·∫£nh < maxImages
        if (imageGrid.querySelectorAll(".variant-image-item.loaded").length < 7 && !imageGrid.querySelector(".variant-upload-box")) {
          imageGrid.appendChild(createUploadBox(imageGrid));
        }
        // Khi ·∫£nh b·ªã x√≥a, c√≥ th·ªÉ c·∫ßn re-validate l·∫°i grid ·∫£nh ƒë·ªÉ hi·ªÉn th·ªã l·ªói n·∫øu kh√¥ng c√≤n ·∫£nh n√†o
        if (imageGrid.querySelectorAll(".variant-image-item.loaded").length === 0) {
          showFieldError(imageGrid, "C·∫ßn √≠t nh·∫•t 1 ·∫£nh cho bi·∫øn th·ªÉ.");
        }
      });

    imageGrid.insertBefore(loadedBox, uploadBox);
    uploadBox.querySelector('input[type="file"]').value = "";

    if (
      imageGrid.querySelectorAll(".variant-image-item.loaded").length >= 7
    ) {
      uploadBox.style.display = "none";
    }

    // TH√äM: X√≥a l·ªói validation cho variant image grid khi ·∫£nh ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng
    clearFieldError(imageGrid);
  }

  function setupVariantImageUpload(variantElement) {
    const imageGrid = variantElement.querySelector(".variant-image-grid");
    if (!imageGrid) return;

    imageGrid.innerHTML = "";

    const maxImages = 7;
    const existingImages = variantElement.variantData?.list_image || [];

    // Render ·∫£nh ƒë√£ c√≥ n·∫øu t·ªìn t·∫°i
    existingImages.forEach((imgUrl) => {
      const imgBox = document.createElement("div");
      imgBox.className = "variant-image-item loaded";
      imgBox.innerHTML = `
                    <img src="${imgUrl}" alt="Preview" style="width:80px;margin:5px;">
                    <button class="remove-image"><i class="fas fa-times"></i></button>
                    <input type="file" hidden />
                `;
      imgBox
        .querySelector(".remove-image")
        .addEventListener("click", function (ev) {
          ev.stopPropagation();
          const publicId = extractPublicIdFromUrl(imgUrl);
          if (publicId) {
            removedImages.push(publicId);
            console.log(
              "[REMOVE IMAGE] ƒê√£ ƒë√°nh d·∫•u x√≥a ·∫£nh bi·∫øn th·ªÉ:",
              publicId
            );
          }
          imgBox.remove();
          if (
            !imageGrid.querySelector(".variant-upload-box") &&
            imageGrid.querySelectorAll(".variant-image-item.loaded").length <
            maxImages
          ) {
            imageGrid.appendChild(createUploadBox(imageGrid));
          }
        });
      imageGrid.appendChild(imgBox);
    });

    // N·∫øu ch∆∞a ƒë·ªß s·ªë l∆∞·ª£ng ·∫£nh, th√™m √¥ upload
    if (existingImages.length < maxImages) {
      imageGrid.appendChild(createUploadBox(imageGrid));
    }
  }

  async function saveNewAttribute(rowElement, counter) {
    const nameInput = rowElement.querySelector(`#newAttributeName-${counter}`);
    const valueTypeSelect = rowElement.querySelector(`#newAttributeValueType-${counter}`);
    const unitInput = rowElement.querySelector(`#newAttributeUnit-${counter}`);
    const selectedCategoryId = document.getElementById("productCategory").value;

    // Clear previous errors for this row
    clearFieldError(nameInput);
    clearFieldError(valueTypeSelect);
    clearFieldError(unitInput);

    const attribute_name = nameInput.value.trim();
    const value_type = valueTypeSelect.value;
    const unit = unitInput.value.trim() || null;
    const is_required = false; // Always false for new custom attributes

    let hasErrors = false;
    if (!attribute_name) {
      showFieldError(nameInput, "T√™n thu·ªôc t√≠nh l√† b·∫Øt bu·ªôc.");
      hasErrors = true;
    }
    if (!value_type) {
      showFieldError(valueTypeSelect, "Lo·∫°i gi√° tr·ªã l√† b·∫Øt bu·ªôc.");
      hasErrors = true;
    }
    if (!selectedCategoryId) {
      showToast("Vui l√≤ng ch·ªçn danh m·ª•c s·∫£n ph·∫©m tr∆∞·ªõc khi th√™m thu·ªôc t√≠nh.", "danger");
      showFieldError(document.getElementById("productCategory"), "Vui l√≤ng ch·ªçn danh m·ª•c.");
      hasErrors = true;
    }

    if (hasErrors) {
      return;
    }

    const payload = {
      attribute_name,
      value_type,
      unit,
      is_required,
    };

    console.log("Attempting to save new attribute:", payload);
    try {
      const rawRes = await fetch(`${API_URL}/api/attribute/${selectedCategoryId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const contentType = rawRes.headers.get("content-type");
      if (!contentType || !contentType.includes("application/json")) {
        const errorText = await rawRes.text(); // ƒë·ªçc text ƒë·ªÉ debug
        console.error("Kh√¥ng ph·∫£i JSON:", errorText);
        showToast("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá t·ª´ server.", "danger");
        return;
      }
      const addAttributeRes = await rawRes.json();

      if (rawRes.ok && addAttributeRes.success) {
        showToast(`ƒê√£ th√™m thu·ªôc t√≠nh m·ªõi: ${attribute_name}`, "success");
        rowElement.remove();
        await loadCategoryAttributes(selectedCategoryId, []);
      } else {
        showToast(addAttributeRes?.message || "Kh√¥ng th·ªÉ th√™m thu·ªôc t√≠nh m·ªõi.", "danger");
        console.error("Failed to save new attribute:", addAttributeRes);
      }

    } catch (error) {
      console.error("L·ªói khi th√™m thu·ªôc t√≠nh m·ªõi:", error);
      showToast(`L·ªói khi th√™m thu·ªôc t√≠nh '${attribute_name}': ${error.message}`, "danger");
    }
  }

  // Placeholder for loadCategoryAttributes - ensures saveNewAttribute works
  async function loadCategoryAttributes(categoryId, productAttributes = []) {
    console.log("Reloading category attributes after saving a new one...");
    await loadDynamicAttributes(categoryId, productAttributes);
  }

  // --- New Functionality: Add Custom Attribute Row ---
  function addCustomAttributeRow() {
    const newAttributesContainer = document.getElementById("newAttributesContainer");
    newAttributeCounter++;
    const rowId = `new-attribute-row-${newAttributeCounter}`;

    const newAttributeHtml = `
            <div class="form-row new-attribute-row" id="${rowId}">
                <div class="form-group col-md-3">
                    <label for="newAttributeName-${newAttributeCounter}">T√™n thu·ªôc t√≠nh</label>
                    <input type="text" id="newAttributeName-${newAttributeCounter}" class="form-control new-attribute-input" placeholder="T√™n thu·ªôc t√≠nh">
                    <div class="invalid-feedback"></div>
                </div>
                <div class="form-group col-md-3">
                    <label for="newAttributeValueType-${newAttributeCounter}">Lo·∫°i gi√° tr·ªã</label>
                    <div class="select-wrapper">
                        <select id="newAttributeValueType-${newAttributeCounter}" class="form-control new-attribute-input">
                            <option value="">Ch·ªçn lo·∫°i</option>
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="material_id">Ch·∫•t li·ªáu</option>
                        </select>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="invalid-feedback"></div>
                </div>
                <div class="form-group col-md-3">
                    <label for="newAttributeUnit-${newAttributeCounter}">ƒê∆°n v·ªã (n·∫øu c√≥)</label>
                    <input type="text" id="newAttributeUnit-${newAttributeCounter}" class="form-control new-attribute-input" placeholder="V√≠ d·ª•: cm, kg">
                    <div class="invalid-feedback"></div>
                </div>
                <div class="form-group col-md-3 d-flex align-items-end justify-content-end gap-2">
                    <button type="button" class="btn btn-primary btn-sm save-new-attribute" data-row-id="${rowId}" data-counter="${newAttributeCounter}">
 L∆∞u
                    </button>
                    <button type="button" class="btn btn-danger btn-sm remove-new-attribute" data-row-id="${rowId}">
                      X√≥a
                    </button>
                </div>
            </div>
        `;
    newAttributesContainer.insertAdjacentHTML('beforeend', newAttributeHtml);

    const newRowElement = document.getElementById(rowId);

    // Add event listener for removing the new attribute row
    newRowElement.querySelector(".remove-new-attribute").addEventListener("click", function () {
      newRowElement.remove();
    });

    // Add event listener for saving the new attribute row
    newRowElement.querySelector(".save-new-attribute").addEventListener("click", function () {
      const counter = parseInt(this.dataset.counter);
      saveNewAttribute(newRowElement, counter);
    });

    // Add input/change listeners to clear errors for new attribute fields
    newRowElement.querySelectorAll(".new-attribute-input").forEach(input => {
      input.addEventListener("input", () => clearFieldError(input));
      input.addEventListener("change", () => clearFieldError(input));
    });
  }

  // Event listener for "Add Attribute" button
  document.querySelector(".btn-add-attribute").addEventListener("click", () => {
    addCustomAttributeRow();
  });

  // ==== Call on page load ====
  window.addEventListener("DOMContentLoaded", () => {
    loadProductDetail();

    // Clear errors when user re-enters (only for initial static inputs)
    const staticInputs = [
      productNameInput,
      productSlugInput,
      productCategorySelect,
      productStatusSelect,
      productDescriptionTextarea,
      productRoomsSelect
    ];

    staticInputs.forEach((input) => {
      if (input) {
        input.addEventListener("input", () => clearFieldError(input));
        input.addEventListener("change", () => clearFieldError(input));
      }
    });
  });

  productNameInput.addEventListener("input", function () {
    const productName = this.value.trim();
    if (productName) {
      productSlugInput.value = productName
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[ƒëƒê]/g, "d")
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/^-+|-+$/g, "");
    } else {
      productSlugInput.value = "";
    }
    clearFieldError(productSlugInput);
  });

  async function deleteVariant(variantId) {
    try {
      const res = await fetch(`${API_URL}/api/variants/${variantId}`, {
        method: "DELETE",
      });
      const result = await res.json();
      if (!res.ok) {
        showToast(
          `Xo√° bi·∫øn th·ªÉ ${variantId} th·∫•t b·∫°i: ` + (result.error || ""),
          "danger"
        );
        console.error("L·ªói xo√° bi·∫øn th·ªÉ:", result);
        return false;
      }
      console.log("‚úÖ Xo√° bi·∫øn th·ªÉ th√†nh c√¥ng:", variantId);
      return true;
    } catch (err) {
      console.error("‚ùå L·ªói khi g·ªçi deleteVariant:", err);
      showToast("L·ªói k·∫øt n·ªëi khi xo√° bi·∫øn th·ªÉ", "danger");
      return false;
    }
  }

  document.querySelector(".btn-save").addEventListener("click", async () => {
    const saveButton = document.querySelector(".btn-save");
    const originalButtonText = saveButton.textContent;
    const validationErrors = [];

    try {
      saveButton.disabled = true;
      saveButton.textContent = "ƒêang l∆∞u...";
      saveButton.classList.add("btn-loading");

      // Clear all previous errors
      document.querySelectorAll(".is-invalid").forEach((el) => el.classList.remove("is-invalid"));
      document.querySelectorAll(".invalid-feedback").forEach((el) => el.textContent = "");
      clearFieldError(mainImageUpload);
      document.querySelectorAll(".variant-image-grid").forEach((grid) => clearFieldError(grid));

      // --- Main Product Validation (Existing Code - Keep) ---
      const name = productNameInput.value.trim();
      const slugValue =
        productSlugInput.value.trim() ||
        name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[ƒëƒê]/g, "d").replace(/[^a-z0-9\s-]/g, "").replace(/\s+/g, "-").replace(/^-+|-+$/g, "");
      const status = parseInt(productStatusSelect.value);
      const category_id = parseInt(productCategorySelect.value);
      const room_ids = Array.from(productRoomsSelect.selectedOptions).map(
        (opt) => parseInt(opt.value)
      );
      const description = productDescriptionTextarea.value.trim();

      if (!name) {
        showFieldError(productNameInput, "T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        validationErrors.push("name");
      }
      if (!slugValue) {
        showFieldError(productSlugInput, "Slug kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        validationErrors.push("slug");
      }
      if (isNaN(status)) {
        showFieldError(productStatusSelect, "Vui l√≤ng ch·ªçn tr·∫°ng th√°i.");
        validationErrors.push("status");
      }
      if (isNaN(category_id)) {
        showFieldError(productCategorySelect, "Vui l√≤ng ch·ªçn danh m·ª•c.");
        validationErrors.push("category_id");
      }
      if (!description) {
        showFieldError(productDescriptionTextarea, "M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");
        validationErrors.push("description");
      }
      if (room_ids.length === 0) {
        showFieldError(productRoomsSelect, "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ph√≤ng.");
        validationErrors.push("room_ids");
      }

      const attributes = [];
      const dynamicAttributesContainer = document.getElementById("dynamicAttributesContainer");
      const dynamicAttributeInputs = dynamicAttributesContainer.querySelectorAll(".dynamic-attribute");
      let hasAttributeErrors = false;

      const attributesMetaRes = await fetch(`${API_URL}/api/categories/${category_id}/attributes`);
      const attributesMeta = attributesMetaRes.ok ? await attributesMetaRes.json() : [];
      const attributesMetaMap = new Map(attributesMeta.map((attr) => [attr.attribute_id, attr]));

      dynamicAttributeInputs.forEach((input) => {
        const attribute_id = parseInt(input.dataset.attributeId);
        const attrMeta = attributesMetaMap.get(attribute_id);

        if (!attrMeta) {
          console.warn(`Thu·ªôc t√≠nh ID ${attribute_id} kh√¥ng t√¨m th·∫•y metadata ho·∫∑c kh√¥ng thu·ªôc danh m·ª•c n√†y.`);
          return;
        }

        const valueType = attrMeta.value_type;
        let value = input.value.trim();
        let material_id = null;

        clearFieldError(input);

        if (valueType === "material_id") {
          material_id = value === "" ? null : parseInt(value);
          value = null;
        } else {
          if (valueType === "number") {
            value = value === "" ? null : parseFloat(value);
          } else {
            value = value === "" ? null : value;
          }
        }

        if (attrMeta.is_required) {
          if (valueType === "material_id") {
            if (material_id === null) {
              showFieldError(input, `"${attrMeta.attribute_name}" l√† b·∫Øt bu·ªôc.`);
              hasAttributeErrors = true;
            }
          } else {
            if (value === null || value === "") {
              showFieldError(input, `"${attrMeta.attribute_name}" l√† b·∫Øt bu·ªôc.`);
              hasAttributeErrors = true;
            }
          }
        }

        if (valueType === "number" && value !== null && isNaN(value)) {
          showFieldError(input, `"${attrMeta.attribute_name}" ph·∫£i l√† s·ªë h·ª£p l·ªá.`);
          hasAttributeErrors = true;
        }

        attributes.push({
          attribute_id: attribute_id,
          value: value,
          material_id: material_id,
        });
      });

      if (hasAttributeErrors) {
        validationErrors.push("attributes");
      }

      let mainImageUrl = mainImagePreview?.src || null;
      if (mainImageUrl && mainImageUrl.startsWith("data:image/")) {
        try {
          const formData = new FormData();
          const resBlob = await fetch(mainImageUrl);
          const blob = await resBlob.blob();
          formData.append("image", blob, "main-image.png");
          formData.append("folder", "SonaSpace/Product");
          formData.append("subfolder", "main");
          const uploadRes = await fetch(`${API_URL}/api/upload/product`, {
            method: "POST",
            body: formData,
          });
          const uploadData = await uploadRes.json();
          if (uploadRes.ok && uploadData.url) {
            mainImageUrl = uploadData.url;
          } else {
            throw new Error(uploadData.error || "Upload ·∫£nh ch√≠nh th·∫•t b·∫°i.");
          }
        } catch (err) {
          console.error("L·ªói upload ·∫£nh ch√≠nh:", err);
          showToast("L·ªói upload ·∫£nh ch√≠nh: " + err.message, "danger");
          validationErrors.push("main_image_upload_failed");
        }
      }
      if (!mainImageUrl) {
        showToast("·∫¢nh ch√≠nh s·∫£n ph·∫©m l√† b·∫Øt bu·ªôc.", "danger");
        mainImageUpload.classList.add("is-invalid");
        validationErrors.push("main_image_missing");
      } else {
        mainImageUpload.classList.remove("is-invalid");
      }

      const variantElements = document.querySelectorAll("#variantsList .variant-item");
      let hasVariantValidationErrors = false;
      const variantsData = [];

      for (const variantEl of variantElements) {
        let variantHasErrors = false;

        const colorSelect = variantEl.querySelector(".variant-color");
        const slugInput = variantEl.querySelector(".variant-slug");
        const quantityInput = variantEl.querySelector(".variant-quantity");
        const priceInput = variantEl.querySelector(".variant-price");
        const salePriceInput = variantEl.querySelector(".variant-sale-price");
        const imageGrid = variantEl.querySelector(".variant-image-grid");

        // Clear previous variant-specific errors
        clearFieldError(colorSelect);
        clearFieldError(slugInput);
        clearFieldError(quantityInput);
        clearFieldError(priceInput);
        clearFieldError(salePriceInput);
        clearFieldError(imageGrid);

        const color_id = parseInt(colorSelect?.value);
        const variantSlug = slugInput?.value.trim();
        const quantity = parseInt(quantityInput?.value);
        const price = parseFloat(priceInput?.value);
        const price_sale = parseFloat(salePriceInput?.value);

        if (isNaN(color_id) || color_id === 0) {
          showFieldError(colorSelect, "Vui l√≤ng ch·ªçn m√†u cho bi·∫øn th·ªÉ.");
          variantHasErrors = true;
        }

        if (isNaN(quantity) || quantity < 0) {
          showFieldError(quantityInput, "S·ªë l∆∞·ª£ng ph·∫£i l√† s·ªë kh√¥ng √¢m.");
          variantHasErrors = true;
        }
        if (isNaN(price) || price <= 0) {
          showFieldError(priceInput, "Vui l√≤ng nh·∫≠p gi√° b√°n.");
          variantHasErrors = true;
        }

        if (price_sale > price) {
          showFieldError(salePriceInput, "Gi√° khuy·∫øn m√£i kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n gi√° b√°n.");
          variantHasErrors = true;
        }

        // Image validation for variant
        const loadedImageBoxes = Array.from(variantEl.querySelectorAll(".variant-image-item.loaded"));
        if (loadedImageBoxes.length === 0) {
          showFieldError(imageGrid, "C·∫ßn √≠t nh·∫•t 1 ·∫£nh cho bi·∫øn th·ªÉ.");
          variantHasErrors = true;
        }

        // If any client-side error found for this variant, mark global flag
        if (variantHasErrors) {
          hasVariantValidationErrors = true;
          // Scroll to the first error in this variant
          const firstInvalidInVariant = variantEl.querySelector(".is-invalid");
          if (firstInvalidInVariant) {
            firstInvalidInVariant.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        } else {
          // Only if variant has no client-side errors, proceed to image upload and collect data
          let list_image_urls = [];
          for (const box of loadedImageBoxes) {
            const img = box.querySelector("img");
            const input = box.querySelector('input[type="file"]');
            if (!img) continue;

            const src = img.src;

            if (input && input.files && input.files.length > 0) {
              const file = input.files[0];
              try {
                const uploadedUrl = await uploadVariantImageToServer(variantEl.getAttribute("data-id") || "temp_id", file);
                if (uploadedUrl) {
                  list_image_urls.push(uploadedUrl);
                  img.src = uploadedUrl;
                  input.value = "";
                } else {
                  variantHasErrors = true;
                  showFieldError(imageGrid, "L·ªói t·∫£i ·∫£nh bi·∫øn th·ªÉ.");
                  hasVariantValidationErrors = true;
                }
              } catch (err) {
                console.error("L·ªói khi t·∫£i ·∫£nh bi·∫øn th·ªÉ:", err);
                showToast(`L·ªói t·∫£i ·∫£nh cho bi·∫øn th·ªÉ: ${err.message}`, "danger");
                variantHasErrors = true;
                showFieldError(imageGrid, `L·ªói t·∫£i ·∫£nh: ${err.message}`);
                hasVariantValidationErrors = true;
              }
            } else if (src.startsWith("http")) {
              list_image_urls.push(src);
            }
          }

          if (!variantHasErrors) {
            variantsData.push({
              variant_id: variantEl.getAttribute("data-id"),
              color_id,
              slug: variantSlug,
              quantity,
              price,
              price_sale,
              list_image: list_image_urls,
            });
          }
        }
      }

      if (hasVariantValidationErrors) {
        validationErrors.push("variants");
      }

      if (validationErrors.length > 0) {
        showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c c√°c th√¥ng tin b·∫Øt bu·ªôc.", "danger");
        const firstInvalid = document.querySelector(".is-invalid");
        if (firstInvalid) {
          firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
        }
        return;
      }
      // --- End Client-side Variant Validation ---

      // --- Deleting removed images (Existing Code - Keep) ---
      if (removedImages.length > 0) {
        for (const publicId of removedImages) {
          try {
            const res = await fetch(`${API_URL}/api/upload/${publicId}`, {
              method: "DELETE",
            });
            if (!res.ok) {
              const result = await res.json();
              console.warn("‚ùå L·ªói xo√° ·∫£nh Cloudinary:", publicId, result.error || res.statusText);
            } else {
              console.log("üóëÔ∏è ƒê√£ xo√° ·∫£nh Cloudinary:", publicId);
            }
          } catch (err) {
            console.error("‚ùå L·ªói k·∫øt n·ªëi khi xo√° ·∫£nh Cloudinary:", err);
          }
        }
        removedImages = [];
      }

      // --- Main Product Payload and Update (Existing Code - Modified) ---
      const payload = {
        name: name,
        slug: slugValue,
        description: description,
        category_id: category_id,
        status: status,
        main_image: mainImageUrl,
        room_ids: room_ids,
        attributes: attributes,
      };
      console.log("[PRODUCT PAYLOAD]", payload);

      const res = await fetch(`${API_URL}/api/products/admin/${slug}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const result = await res.json();

      if (!res.ok) {
        if (result.errors && Array.isArray(result.errors)) {
          result.errors.forEach((err) => {
            const field = err.field;
            const message = err.message;

            if (field === "name") {
              showFieldError(productNameInput, message);
            } else if (field === "slug") {
              showFieldError(productSlugInput, message);
            } else if (field === "category_id") {
              showFieldError(productCategorySelect, message);
            } else if (field === "status") {
              showFieldError(productStatusSelect, message);
            } else if (field === "description") {
              showFieldError(productDescriptionTextarea, message);
            } else if (field === "room_ids") {
              showFieldError(productRoomsSelect, message);
            } else if (field === "main_image") {
              showToast(message, "danger");
              mainImageUpload.classList.add("is-invalid");
            } else if (field.startsWith("attributes[")) {
              const match = field.match(/attributes\[(\d+)\](?:\.(.+))?/);
              if (match) {
                const attributeId = parseInt(match[1], 10);
                const input = document.getElementById(`attr-${attributeId}`);
                if (input) {
                  showFieldError(input, message);
                } else {
                  showToast(`L·ªói thu·ªôc t√≠nh ${attributeId}: ${message}`, "danger");
                }
              }
            } else if (field.startsWith("variants[")) {
              const match = field.match(/variants\[(\d+)\]\.(.+)/);
              if (match) {
                const index = parseInt(match[1], 10);
                const fieldName = match[2];

                const variantEl = document.querySelectorAll(
                  "#variantsList .variant-item"
                )[index];
                if (variantEl) {
                  let input;
                  if (fieldName === "slug") {
                    input = variantEl.querySelector(".variant-slug");
                  } else if (fieldName === "quantity") {
                    input = variantEl.querySelector(".variant-quantity");
                  } else if (fieldName === "price") {
                    input = variantEl.querySelector(".variant-price");
                  } else if (fieldName === "price_sale") {
                    input = variantEl.querySelector(".variant-sale-price");
                  } else if (fieldName === "color_id") {
                    input = variantEl.querySelector(".variant-color");
                  } else if (fieldName === "list_image") {
                    const imageGrid = variantEl.querySelector(".variant-image-grid");
                    if (imageGrid) {
                      showFieldError(imageGrid, message);
                    }
                    return;
                  }
                  if (input) {
                    showFieldError(input, message);
                  }
                }
              }
            }
          });
          const firstInvalid = document.querySelector(".is-invalid");
          if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }
        showToast(result.error || "L·ªói khi c·∫≠p nh·∫≠t s·∫£n ph·∫©m.", "danger");
        return;
      }



      showToast("C·∫≠p nh·∫≠t th√¥ng tin s·∫£n ph·∫©m th√†nh c√¥ng!", "success");

      const productId =
        result.product?.id || result.product?.product_id || result.product_id;

      const currentVariantIdsInDom = new Set(
        Array.from(variantElements)
          .map((el) => el.getAttribute("data-id"))
          .filter((id) => id && id !== "new")
      );

      const allVariantIdsLoadedBefore = Array.from(document.querySelectorAll("#variantsList .variant-item[data-id]"))
        .map(el => el.getAttribute("data-id"))
        .filter(id => id && id !== "new");

      const deletedIds = allVariantIdsLoadedBefore.filter(
        (id) => !currentVariantIdsInDom.has(id)
      );

      for (const delId of deletedIds) {
        if (delId) {
          await deleteVariant(delId);
        }
      }

      // --- Process Variants (Modified) ---
      let allVariantsProcessedSuccessfully = true;

      for (const variantPayload of variantsData) {
        let variantId = variantPayload.variant_id;

        if (variantId && variantId !== "new") {
          // Update existing variant
          const variantUpdateResult = await updateVariant(variantId, variantPayload);
          if (!variantUpdateResult) {
            allVariantsProcessedSuccessfully = false;
          }
        } else {
          // Add new variant
          const created = await addVariant(productId, variantPayload);
          if (!created || !created.variant_id) {
            allVariantsProcessedSuccessfully = false;
          } else {
            // Update the DOM element with the real ID
            const variantEl = Array.from(document.querySelectorAll("#variantsList .variant-item[data-id='new']")).find(el => {
              const color_id_dom = parseInt(el.querySelector(".variant-color")?.value);
              const slug_dom = el.querySelector(".variant-slug")?.value.trim();
              return color_id_dom === variantPayload.color_id && slug_dom === variantPayload.slug;
            });
            if (variantEl) {
              variantEl.setAttribute("data-id", created.variant_id);
            }
          }
        }
      }

      if (allVariantsProcessedSuccessfully) {
        showToast("T·∫•t c·∫£ bi·∫øn th·ªÉ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
      } else {
        showToast(
          "C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t m·ªôt ho·∫∑c nhi·ªÅu bi·∫øn th·ªÉ. Vui l√≤ng ki·ªÉm tra l·∫°i.",
          "danger"
        );
      }

      setTimeout(() => {
        window.location.href = "/dashboard/products";
      }, 1500);
    } catch (err) {
      console.error("L·ªói khi l∆∞u s·∫£n ph·∫©m:", err);
      showToast("L·ªói khi l∆∞u s·∫£n ph·∫©m: " + err.message, "danger");
    } finally {
      saveButton.disabled = false;
      saveButton.textContent = originalButtonText;
      saveButton.classList.remove("btn-loading");
    }
  });

  async function updateVariant(variantId, data) {
    try {
      const res = await fetch(`${API_URL}/api/variants/${variantId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      const result = await res.json();
      if (!res.ok) {
        console.error("‚ùå L·ªói c·∫≠p nh·∫≠t variant:", result);
        showToast("C·∫≠p nh·∫≠t bi·∫øn th·ªÉ th·∫•t b·∫°i", "danger");
        return null;
      }

      console.log("‚úÖ C·∫≠p nh·∫≠t variant th√†nh c√¥ng:", result);
      return result;
    } catch (err) {
      console.error("‚ùå L·ªói k·∫øt n·ªëi khi g·ªçi updateVariant:", err);
      showToast("L·ªói k·∫øt n·ªëi khi c·∫≠p nh·∫≠t bi·∫øn th·ªÉ", "danger");
      return null;
    }
  }

  async function addVariant(productId, data) {
    try {
      console.log("[ADD VARIANT PAYLOAD] for productId:", productId, "Data:", data);
      const res = await fetch(`${API_URL}/api/variants/${productId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      const result = await res.json();
      if (!res.ok) {
        console.error("‚ùå L·ªói t·∫°o bi·∫øn th·ªÉ:", result);
        showToast("T·∫°o bi·∫øn th·ªÉ th·∫•t b·∫°i", "danger");
        return null;
      }

      console.log("‚úÖ T·∫°o bi·∫øn th·ªÉ th√†nh c√¥ng:", result);
      return result;
    } catch (err) {
      console.error("‚ùå L·ªói k·∫øt n·ªëi khi g·ªçi addVariant:", err);
      showToast("L·ªói k·∫øt n·ªëi khi t·∫°o bi·∫øn th·ªÉ", "danger");
      return null;
    }
  }

  document
    .querySelector(".btn-add-variant")
    .addEventListener("click", async function () {
      const newVariant = variantTemplate.cloneNode(true);
      newVariant.style.display = "block";
      newVariant.removeAttribute("id");
      newVariant.setAttribute("data-id", "new");
      newVariant.classList.add("variant-item");

      const colorSelect = newVariant.querySelector(".variant-color");
      colorSelect.innerHTML = '<option value="">Ch·ªçn m√†u</option>' + globalColors
        .map(
          (color) =>
            `<option value="${color.color_id}">${color.color_name}</option>`
        )
        .join("");

      setupVariantEvents(newVariant);
      variantsList.appendChild(newVariant);
      showToast("ƒê√£ th√™m m·ªôt bi·∫øn th·ªÉ m·ªõi.", "success");
      newVariant.scrollIntoView({ behavior: "smooth", block: "center" });
    });

  function setupVariantEvents(variantElement) {
    variantElement
      .querySelector(".btn-toggle-variant")
      ?.addEventListener("click", function () {
        const content = variantElement.querySelector(".variant-content");
        const icon = this.querySelector("i");
        if (content.style.display === "none") {
          content.style.display = "block";
          icon.classList.replace("fa-chevron-down", "fa-chevron-up");
        } else {
          content.style.display = "none";
          icon.classList.replace("fa-chevron-up", "fa-chevron-down");
        }
      });
    variantElement.querySelectorAll("input, select").forEach((input) => {
      input.addEventListener("input", () => clearFieldError(input));
      input.addEventListener("change", () => clearFieldError(input));
    });

    // X√≥a bi·∫øn th·ªÉ
    variantElement
      .querySelector(".btn-remove-variant")
      ?.addEventListener("click", async function () {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a bi·∫øn th·ªÉ n√†y?")) {
          const variantId = variantElement.getAttribute("data-id");

          if (variantId && variantId !== "new") {
            const success = await deleteVariant(variantId);
            if (!success) {
              return;
            }
          }

          // D√π l√† m·ªõi hay c≈© ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi DB, th√¨ x√≥a kh·ªèi DOM
          console.log(
            "[REMOVE VARIANT] ƒê√£ x√≥a bi·∫øn th·ªÉ kh·ªèi DOM:",
            variantId || "new (ch∆∞a c√≥ ID)"
          );
          variantElement.remove();
          showToast("ƒê√£ x√≥a bi·∫øn th·ªÉ.", "info");
        }
      });

    // T·ª± ƒë·ªông t·∫°o slug khi ch·ªçn m√†u
    const colorSelect = variantElement.querySelector(".variant-color");
    const slugInput = variantElement.querySelector(".variant-slug");
    if (colorSelect && slugInput) {
      colorSelect.addEventListener("change", () => {
        const selectedOption = colorSelect.options[colorSelect.selectedIndex];
        const colorName = selectedOption?.textContent?.trim() || "";

        if (colorName) {
          slugInput.value = colorName
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[ƒëƒê]/g, "d")
            .replace(/[^a-z0-9\s-]/g, "")
            .replace(/\s+/g, "-")
            .replace(/-+/g, "-")
            .replace(/^-+|-+$/g, "");
        } else {
          slugInput.value = "";
        }
        clearFieldError(slugInput);
      });
    }

    // X·ª≠ l√Ω upload ·∫£nh bi·∫øn th·ªÉ
    setupVariantImageUpload(variantElement);

    // Lu√¥n ƒë·∫£m b·∫£o ph·∫ßn .variant-content hi·ªÉn th·ªã khi th√™m m·ªõi
    const content = variantElement.querySelector(".variant-content");
    if (content) content.style.display = "block";
  }

  // H√†m upload ·∫£nh bi·∫øn th·ªÉ l√™n server v√† tr·∫£ v·ªÅ URL
  async function uploadVariantImageToServer(variantId, file) {
    const formData = new FormData();
    formData.append("image", file);
    formData.append("folder", "SonaSpace/Product");
    formData.append("subfolder", "variant");

    try {
      const token = localStorage.getItem("token");
      const headers = {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }

      const res = await fetch(`${API_URL}/api/upload/product`, {
        method: "POST",
        headers: headers,
        body: formData,
      });

      const result = await res.json();
      if (!res.ok || !result.url) {
        showToast("L·ªói upload ·∫£nh: " + (result.error || "Kh√¥ng r√µ"), "danger");
        return null;
      }

      return result.url;
    } catch (error) {
      console.error("L·ªói k·∫øt n·ªëi:", error);
      showToast("L·ªói k·∫øt n·ªëi khi upload ·∫£nh", "danger");
      return null;
    }
  }
  function showToast(message, type = "success") {
    let toastContainer = document.getElementById("toastContainer");
    if (!toastContainer) {
      toastContainer = document.createElement("div");
      toastContainer.id = "toastContainer";
      toastContainer.className = "position-fixed top-0 end-0 p-3";
      toastContainer.style.zIndex = "1050";
      document.body.appendChild(toastContainer);
    }

    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");

    toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();

    toast.addEventListener("hidden.bs.toast", () => toast.remove());
  }
</script>