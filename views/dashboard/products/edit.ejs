<!-- Trang S·ª≠a S·∫£n ph·∫©m -->

<!-- Ti√™u ƒë·ªÅ -->
<div class="dashboard-header-row">
  <h2 class="dashboard-title">S·ª≠a s·∫£n ph·∫©m</h2>
</div>

<!-- Container ch√≠nh - chia 2 c·ªôt -->
<div class="add-product-container">
  <!-- C·ªôt tr√°i: Form th√¥ng tin s·∫£n ph·∫©m -->
  <div class="product-form-column">

    <!-- ===== Th√¥ng tin s·∫£n ph·∫©m c∆° b·∫£n ===== -->
    <div class="form-section">
      <h3 class="section-title">Th√¥ng tin s·∫£n ph·∫©m</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="productName">T√™n s·∫£n ph·∫©m</label>
          <input type="text" id="productName" class="form-control" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m" />
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label for="productSlug">Slug</label>
          <input type="text" id="productSlug" class="form-control" placeholder="C√≥ th·ªÉ t·ª± t·∫°o n·∫øu b·ªè tr·ªëng" />
        </div>
        <div class="form-group">
          <label for="productStatus">Tr·∫°ng th√°i</label>
          <div class="select-wrapper">
            <select id="productStatus" class="form-control">
              <option value="">Ch·ªçn tr·∫°ng th√°i</option>
              <option value="1">Hi·ªÉn th·ªã</option>
              <option value="0">·∫®n</option>
            </select>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="invalid-feedback"></div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="productCategory">Danh m·ª•c</label>
          <div class="select-wrapper">
            <select id="productCategory" class="form-control"></select>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label for="productRooms">Danh m·ª•c ph√≤ng</label>
          <div class="select-wrapper">
            <select id="productRooms" class="form-control"></select>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="invalid-feedback"></div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label for="productDescription">M√¥ t·∫£</label>
          <textarea id="productDescription" class="form-control" rows="5" placeholder="Nh·∫≠p m√¥ t·∫£"></textarea>
          <div class="invalid-feedback"></div>
        </div>

      </div>
    </div>

    <!-- ===== Th√¥ng tin b·ªï sung ===== -->
    <div class="form-section">
      <h3 class="section-title">Th√¥ng tin b·ªï sung</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="productDepth">ƒê·ªô s√¢u (cm)</label>
          <input type="number" id="productDepth" class="form-control" placeholder="Nh·∫≠p ƒë·ªô s√¢u" />
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label for="productWidth">Chi·ªÅu r·ªông (cm)</label>
          <input type="number" id="productWidth" class="form-control" placeholder="Nh·∫≠p chi·ªÅu r·ªông" />
          <div class="invalid-feedback"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="productHeight">Chi·ªÅu cao (cm)</label>
          <input type="number" id="productHeight" class="form-control" placeholder="Nh·∫≠p chi·ªÅu cao" />
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label for="productMaxLoad">T·∫£i tr·ªçng t·ªëi ƒëa (kg)</label>
          <input type="number" id="productMaxLoad" class="form-control" placeholder="Nh·∫≠p t·∫£i tr·ªçng" />
          <div class="invalid-feedback"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="productSeatHeight">Chi·ªÅu cao ch·ªó ng·ªìi (cm)</label>
          <input type="number" id="productSeatHeight" class="form-control" placeholder="Nh·∫≠p chi·ªÅu cao ch·ªó ng·ªìi" />
          <div class="invalid-feedback"></div>
        </div>
        <div class="form-group">
          <label for="productMaterial">Ch·∫•t li·ªáu</label>
          <input type="text" id="productMaterial" class="form-control" placeholder="Nh·∫≠p ch·∫•t li·ªáu" />
          <div class="invalid-feedback"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- C·ªôt ph·∫£i: ·∫¢nh v√† bi·∫øn th·ªÉ -->
  <div class="right-column">
    <!-- ===== ·∫¢nh ch√≠nh ===== -->
    <div class="form-section">
      <h3 class="section-title">·∫¢nh ch√≠nh s·∫£n ph·∫©m</h3>
      <div class="main-image-upload" id="mainImageUpload" style="display: none;">
        <div class="upload-zone">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>K√©o th·∫£ ho·∫∑c click ƒë·ªÉ t·∫£i ·∫£nh</p>
          <p class="upload-hint">ƒê·ªãnh d·∫°ng: JPG, PNG (T·ªëi ƒëa 5MB)</p>
          <input type="file" hidden accept="image/*" />
        </div>
      </div>
      <div class="main-image-preview" style="display: none">
        <img src="" alt="Preview" />
        <button class="remove-image"><i class="fas fa-times"></i></button>
      </div>
    </div>

    <!-- ===== Bi·∫øn th·ªÉ ===== -->
    <div class="form-section">
      <div class="variant-header">
        <h3 class="section-title">Bi·∫øn th·ªÉ s·∫£n ph·∫©m</h3>
        <button type="button" class="btn btn-add-variant">
          <i class="fas fa-plus"></i> Th√™m bi·∫øn th·ªÉ
        </button>
      </div>
      <div id="variantsList">
        <!-- Template Bi·∫øn th·ªÉ -->
        <div class="variant-item" style="display: none" id="variantTemplate">
          <div class="variant-header">
            <h4 class="variant-title">Bi·∫øn th·ªÉ m·ªõi</h4>
            <div class="variant-actions">
              <button class="btn-toggle-variant"><i class="fas fa-chevron-down"></i></button>
              <button class="btn-remove-variant"><i class="fas fa-trash"></i></button>
            </div>
          </div>

          <div class="variant-content">
            <div class="form-row">
              <div class="form-group">
                <label>T√™n m√†u</label>
                <div class="select-wrapper">
                  <select class="form-control variant-color">
                    <option value="">Ch·ªçn m√†u</option>
                  </select>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label>Slug</label>
                <input type="text" class="form-control variant-slug" placeholder="T·ª± ƒë·ªông t·∫°o n·∫øu ƒë·ªÉ tr·ªëng" />
                <div class="invalid-feedback"></div>
              </div>

            </div>


            <div class="form-row">
              <div class="form-group">
                <label>S·ªë l∆∞·ª£ng</label>
                <input type="number" class="form-control variant-quantity" min="0" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng" />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label>Gi√° g·ªëc</label>
                <input type="number" class="form-control variant-price" min="0" placeholder="Nh·∫≠p gi√° g·ªëc" />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label>Gi√° gi·∫£m</label>
                <input type="number" class="form-control variant-sale-price" min="0" placeholder="Nh·∫≠p gi√° gi·∫£m" />
                <div class="invalid-feedback"></div>
              </div>
            </div>

            <div class="variant-images">
              <label>H√¨nh ·∫£nh bi·∫øn th·ªÉ</label>
              <div class="variant-image-grid"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="form-actions">
  <button type="button" class="btn btn-cancel">H·ªßy</button>
  <button type="button" class="btn btn-save">L∆∞u</button>
</div>

<script>
  function showFieldError(input, message) {
    if (!input) return;
    input.classList.add("is-invalid");

    let feedback = input.parentElement.querySelector(".invalid-feedback");
    if (!feedback) {
      feedback = document.createElement("div");
      feedback.className = "invalid-feedback";
      input.parentElement.appendChild(feedback);
    }
    feedback.textContent = message;
  }


  function clearFieldError(input) {
    if (!input) return;
    input.classList.remove("is-invalid");
    input.parentElement.querySelector(".invalid-feedback")?.remove();
  }

  const API_URL = "http://localhost:3501";
  const slug = window.location.pathname.split("/").pop();
  let globalColors = [];

  const productNameInput = document.getElementById("productName");
  const productSlugInput = document.getElementById("productSlug");
  const productStatusSelect = document.getElementById("productStatus");
  const productCategorySelect = document.getElementById("productCategory");
  const productRoomsSelect = document.getElementById("productRooms");
  const productDescriptionTextarea = document.getElementById("productDescription");
  const productDepthInput = document.getElementById("productDepth");
  const productWidthInput = document.getElementById("productWidth");
  const productHeightInput = document.getElementById("productHeight");
  const productMaxLoadInput = document.getElementById("productMaxLoad");
  const productSeatHeightInput = document.getElementById("productSeatHeight");
  const productMaterialInput = document.getElementById("productMaterial");

  const mainImagePreview = document.querySelector(".main-image-preview img");
  const mainImageContainer = document.querySelector(".main-image-preview");
  const mainImageUpload = document.getElementById("mainImageUpload");
  const mainImageUploadInput = mainImageUpload.querySelector('input[type="file"]');

  const variantTemplate = document.getElementById("variantTemplate");
  const variantsList = document.getElementById("variantsList");
  let removedImages = [];

  function extractPublicIdFromUrl(url) {
    const matches = url.match(/upload\/(?:v\d+\/)?([^\.]+)\.(jpg|jpeg|png|webp|gif)/);
    if (!matches || !matches[1]) return null;
    return matches[1];
  }



  // X·ª≠ l√Ω x√≥a ·∫£nh ch√≠nh
  mainImageContainer.querySelector(".remove-image")?.addEventListener("click", () => {
    const publicId = extractPublicIdFromUrl(mainImagePreview.src);
    if (publicId) {
      removedImages.push(publicId);
      console.log("[REMOVE IMAGE] ƒê√£ ƒë√°nh d·∫•u x√≥a ·∫£nh ch√≠nh:", publicId);
    }
    mainImagePreview.src = "";
    mainImageContainer.style.display = "none";
    // Hi·ªán l·∫°i box upload ·∫£nh ch√≠nh
    mainImageUpload.style.display = "block";
    mainImageUploadInput.value = "";
  });

  // X·ª≠ l√Ω upload ·∫£nh ch√≠nh m·ªõi
  mainImageUpload.addEventListener("click", () => mainImageUploadInput.click());
  mainImageUploadInput.addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = function (e) {
        mainImagePreview.src = e.target.result;
        mainImageContainer.style.display = "block";
        mainImageUpload.style.display = "none";
      };
      reader.readAsDataURL(file);
    }
  });

  // ==== Load s·∫£n ph·∫©m ====
  async function loadProductDetail() {
    try {
      const res = await fetch(`${API_URL}/api/products/admin/${slug}`);
      const data = await res.json();
      const product = data.product;

      // === Th√¥ng tin s·∫£n ph·∫©m ===
      productNameInput.value = product.name || "";
      productSlugInput.value = product.slug || "";
      productStatusSelect.value = product.status ?? "";
      productCategorySelect.value = product.category_id ?? "";
      productDescriptionTextarea.value = product.description || "";
      productDepthInput.value = product.depth ?? "";
      productWidthInput.value = product.width ?? "";
      productHeightInput.value = product.height ?? "";
      productMaxLoadInput.value = product.max_weight_load ?? "";
      productSeatHeightInput.value = product.seating_height ?? "";
      productMaterialInput.value = product.materials || "";

      // === ·∫¢nh ch√≠nh (l·∫•y t·ª´ product.product_image) ===
      if (product.main_image) {
        mainImagePreview.src = product.main_image;
        mainImageContainer.style.display = "block";
        mainImageUpload.style.display = "none";
      } else {
        mainImagePreview.src = "";
        mainImageContainer.style.display = "none";
        mainImageUpload.style.display = "block";
      }

      // Load danh s√°ch select boxes (ph·∫£i g·ªçi ·ªü ƒë√¢y v√¨ c·∫ßn category_id v√† room_ids)
      await loadProductSelectBoxes(slug, product.category_id, data.rooms?.map(r => r.room_id), null);

      // === Danh s√°ch bi·∫øn th·ªÉ ===
      // X√≥a h·∫øt bi·∫øn th·ªÉ c≈© tr∆∞·ªõc khi render l·∫°i
      variantsList.innerHTML = "";

      product.variants.forEach((variant, idx) => {
        const clone = variantTemplate.cloneNode(true);
        clone.style.display = "block";
        clone.removeAttribute("id");
        clone.setAttribute("data-id", variant.variant_id);
        clone.classList.add("variant-item");

        // Ti√™u ƒë·ªÅ
        clone.querySelector(".variant-title").textContent = variant.color_name || `Bi·∫øn th·ªÉ ${idx + 1}`;

        // Render l·∫°i danh s√°ch m√†u cho select box n√†y
        const colorSelect = clone.querySelector(".variant-color");
        colorSelect.innerHTML = globalColors.map(
          (color) =>
            `<option value="${color.color_id}" ${color.color_id == variant.color_id ? "selected" : ""}>${color.color_name}</option>`
        ).join("");

        // G√°n d·ªØ li·ªáu kh√°c
        colorSelect.value = variant.color_id;
        clone.querySelector(".variant-slug").value = variant.slug || "";
        clone.querySelector(".variant-quantity").value = variant.quantity ?? 0;
        clone.querySelector(".variant-price").value = variant.price ?? 0;
        clone.querySelector(".variant-sale-price").value = variant.price_sale ?? 0;

        // L∆∞u l·∫°i d·ªØ li·ªáu variant v√†o node ƒë·ªÉ submit
        clone.variantData = {
          color_id: variant.color_id,
          variant_slug: variant.slug || "",
          quantity: variant.quantity,
          price: variant.price ?? 0,
          price_sale: variant.price_sale ?? 0,
          // http...,http...,http...
          list_image: typeof variant.list_image === "string"
            ? variant.list_image.split(",")
            : (Array.isArray(variant.list_image) ? variant.list_image : []),
        };

        variantsList.appendChild(clone);
        setupVariantEvents(clone);
      });

      // N·∫øu mu·ªën render l·∫°i dropdown m√†u cho c√°c select c√≤n l·∫°i (v√≠ d·ª• khi th√™m m·ªõi bi·∫øn th·ªÉ)
      document.querySelectorAll(".variant-color").forEach((select) => {
        if (!select.value) { // ch·ªâ render n·∫øu ch∆∞a c√≥ gi√° tr·ªã
          select.innerHTML = globalColors.map(
            (color) =>
              `<option value="${color.color_id}">${color.color_name}</option>`
          ).join("");
        }
      });
    } catch (err) {
      console.error("L·ªói load s·∫£n ph·∫©m:", err);
      alert("Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m");
    }
    // setupAllVariantEvents();
  }

  async function loadProductSelectBoxes(slug, selectedCategoryId, selectedRoomIds, selectedColorId) {
    try {
      // G·ªçi ƒë·ªìng th·ªùi 3 API
      const [categoryRes, roomsRes, colorsRes] = await Promise.all([
        fetch(`${API_URL}/api/categories`),
        fetch(`${API_URL}/api/rooms`),
        fetch(`${API_URL}/api/color/filter`),
      ]);

      const [categories, rooms, colors] = await Promise.all([
        categoryRes.json(),
        roomsRes.json(),
        colorsRes.json(),
      ]);

      globalColors = colors; // L∆∞u l·∫°i danh s√°ch m√†u cho c√°c n∆°i kh√°c d√πng

      // ===== Category select =====
      productCategorySelect.innerHTML = categories.map(c =>
        `<option value="${c.category_id}" ${c.category_id == selectedCategoryId ? "selected" : ""}>${c.category_name}</option>`
      ).join("");

      // ===== Rooms select =====
      // productRoomsSelect.innerHTML = rooms.map(r =>
      //   `<option value="${r.room_id}" ${r.room_id == selectedRoomIds ? "selected" : ""}>${r.room_name}</option>`
      // ).join("");
      productRoomsSelect.innerHTML = rooms.map(r =>
        `<option value="${r.room_id}" ${selectedRoomIds?.includes(r.room_id) ? "selected" : ""}>${r.room_name}</option>`
      ).join("");

      // Kh√¥ng c·∫ßn render dropdown m√†u ·ªü ƒë√¢y n·ªØa, s·∫Ω render ·ªü loadProductDetail cho t·ª´ng bi·∫øn th·ªÉ
    } catch (error) {
      console.error("L·ªói khi t·∫£i select boxes:", error);
      showToast("L·ªói khi t·∫£i th√¥ng tin danh m·ª•c / ph√≤ng / m√†u s·∫Øc", "danger");
    }
  }

  // Th√™m h√†m t·∫°o box upload d·∫•u c·ªông cho variant
  function createUploadBox(imageGrid, variantId = null) {
    const uploadBox = document.createElement("div");
    uploadBox.className = "variant-image-item active variant-upload-box";
    uploadBox.innerHTML = `
    <div class="upload-placeholder">
      <i class="fas fa-plus"></i>
      <input type="file" hidden accept="image/*" />
    </div>
  `;

    const input = uploadBox.querySelector('input[type="file"]');
    const maxImages = 7;

    uploadBox.addEventListener("click", () => input.click());

    input.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function (event) {
          console.log("·∫¢nh bi·∫øn th·ªÉ src:", event.target.result);
          addLoadedImageBox(event.target.result, imageGrid, uploadBox, file);
        };
        reader.readAsDataURL(file);
      }
    });

    return uploadBox;
  }


  // H√†m th√™m box ·∫£nh ƒë√£ upload th√†nh c√¥ng v√†o grid
  function addLoadedImageBox(imgUrl, imageGrid, uploadBox, file) {
    const loadedBox = document.createElement("div");
    loadedBox.className = "variant-image-item loaded";
    loadedBox.dataset.local = "true"; // ƒë√°nh d·∫•u l√† ·∫£nh m·ªõi
    loadedBox.dataset.filename = file?.name || "";

    loadedBox.innerHTML = `
    <img src="${imgUrl}" alt="Preview" style="width:80px;margin:5px;">
    <button class="remove-image"><i class="fas fa-times"></i></button>
    <input type="file" hidden />
  `;

    // L∆∞u l·∫°i file ƒë·ªÉ upload v·ªÅ sau
    const hiddenInput = loadedBox.querySelector('input[type="file"]');
    if (file) {
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      hiddenInput.files = dataTransfer.files;
    }

    loadedBox.querySelector(".remove-image").addEventListener("click", function (ev) {
      ev.stopPropagation();
      loadedBox.remove();
      if (!imageGrid.querySelector('.variant-upload-box')) {
        imageGrid.appendChild(createUploadBox(imageGrid));
      }
    });

    imageGrid.insertBefore(loadedBox, uploadBox);
    uploadBox.querySelector('input[type="file"]').value = "";

    if (imageGrid.querySelectorAll('.variant-image-item.loaded').length >= 7) {
      uploadBox.style.display = "none";
    }
  }


  // S·ª≠a l·∫°i setupVariantImageUpload ƒë·ªÉ truy·ªÅn variantId cho createUploadBox
  function setupVariantImageUpload(variantElement) {
    const imageGrid = variantElement.querySelector(".variant-image-grid");
    if (!imageGrid) return;

    imageGrid.innerHTML = "";

    const maxImages = 7;
    const existingImages = variantElement.variantData?.list_image || [];
    const variantId = variantElement.getAttribute("data-id") || null;

    // Render ·∫£nh ƒë√£ c√≥ n·∫øu t·ªìn t·∫°i
    existingImages.forEach((imgUrl) => {
      const imgBox = document.createElement("div");
      imgBox.className = "variant-image-item loaded";
      imgBox.innerHTML = `
      <img src="${imgUrl}" alt="Preview" style="width:80px;margin:5px;">
      <button class="remove-image"><i class="fas fa-times"></i></button>
    `;
      imgBox.querySelector(".remove-image").addEventListener("click", function (ev) {
        ev.stopPropagation();
        const publicId = extractPublicIdFromUrl(imgUrl);
        if (publicId) {
          removedImages.push(publicId);
          console.log("[REMOVE IMAGE] ƒê√£ ƒë√°nh d·∫•u x√≥a ·∫£nh bi·∫øn th·ªÉ:", publicId);
        }
        imgBox.remove();
        if (!imageGrid.querySelector('.variant-upload-box') && imageGrid.querySelectorAll('.variant-image-item.loaded').length < maxImages) {
          imageGrid.appendChild(createUploadBox(imageGrid, variantId));
        }
      });
      imageGrid.appendChild(imgBox);
    });

    // N·∫øu ch∆∞a ƒë·ªß s·ªë l∆∞·ª£ng ·∫£nh, th√™m √¥ upload
    if (existingImages.length < maxImages) {
      imageGrid.appendChild(createUploadBox(imageGrid, variantId));
    }
  }

  // ==== G·ªçi khi t·∫£i trang ====
  window.addEventListener("DOMContentLoaded", () => {
    loadProductDetail();

    // Clear l·ªói khi ng∆∞·ªùi d√πng nh·∫≠p l·∫°i
    const allInputs = [
      productNameInput,
      productSlugInput,
      productCategorySelect,
      productStatusSelect,
      productDescriptionTextarea,
      productMaterialInput,
      productDepthInput,
      productWidthInput,
      productHeightInput,
      productSeatHeightInput,
      productMaxLoadInput
    ];


    allInputs.forEach(input => {
      if (!input) return;
      input.addEventListener("input", () => clearFieldError(input));
      input.addEventListener("change", () => clearFieldError(input));
    });
  });


  async function deleteVariant(variantId) {
    try {
      const res = await fetch(`${API_URL}/api/variants/${variantId}`, {
        method: "DELETE",
      });
      const result = await res.json();
      if (!res.ok) {
        showToast(`Xo√° bi·∫øn th·ªÉ ${variantId} th·∫•t b·∫°i: ` + (result.error || ""), "danger");
        console.error("L·ªói xo√° bi·∫øn th·ªÉ:", result);
        return;
      }
      console.log("‚úÖ Xo√° bi·∫øn th·ªÉ th√†nh c√¥ng:", variantId);
    } catch (err) {
      console.error("‚ùå L·ªói khi g·ªçi deleteVariant:", err);
      showToast("L·ªói k·∫øt n·ªëi khi xo√° bi·∫øn th·ªÉ", "danger");
    }
  }


  // ==== X·ª≠ l√Ω s·ª± ki·ªán n√∫t l∆∞u (ch·ªâ c·∫≠p nh·∫≠t th√¥ng tin chung s·∫£n ph·∫©m) ====
  document.querySelector(".btn-save").addEventListener("click", async () => {
    try {
      // ===== L·∫§Y D·ªÆ LI·ªÜU FORM =====
      const name = productNameInput.value.trim();
      const slugValue = productSlugInput.value.trim() || name.toLowerCase().replace(/\s+/g, "-");
      const status = parseInt(productStatusSelect.value);
      const category_id = parseInt(productCategorySelect.value);
      const room_ids = Array.from(productRoomsSelect.selectedOptions).map(opt => parseInt(opt.value));
      const description = productDescriptionTextarea.value.trim();
      const depth = parseFloat(productDepthInput.value) || null;
      const width = parseFloat(productWidthInput.value) || null;
      const height = parseFloat(productHeightInput.value) || null;
      const max_weight_load = parseFloat(productMaxLoadInput.value) || null;
      const seating_height = parseFloat(productSeatHeightInput.value) || null;
      const materials = productMaterialInput.value.trim();

      // ·∫¢nh ch√≠nh
      let mainImageUrl = mainImagePreview?.src || null;
      if (mainImageUrl && mainImageUrl.startsWith("data:image/")) {
        try {
          const formData = new FormData();
          const res = await fetch(mainImageUrl);
          const blob = await res.blob();
          formData.append("image", blob, "main-image.png");
          formData.append("folder", "SonaSpace/Product");
          formData.append("subfolder", "main");
          const uploadRes = await fetch(`${API_URL}/api/upload/product`, {
            method: "POST",
            body: formData,
          });
          const uploadData = await uploadRes.json();
          mainImageUrl = uploadData.url || mainImageUrl;
        } catch (err) {
          showToast("L·ªói upload ·∫£nh ch√≠nh", "danger");
        }
      }

      // X√ìA C√ÅC ·∫¢NH ƒê√É ·∫§N D·∫§U ‚ùå
      if (removedImages.length > 0) {
        for (const publicId of removedImages) {
          try {
            const res = await fetch(`${API_URL}/api/upload/${publicId}`, {
              method: "DELETE",
            });
            const result = await res.json();
            if (!res.ok) {
              console.warn("‚ùå L·ªói xo√° ·∫£nh:", result);
            } else {
              console.log("üóëÔ∏è ƒê√£ xo√° ·∫£nh:", publicId);
            }
            console.log("[REMOVE IMAGE] ƒê√£ g·ª≠i y√™u c·∫ßu x√≥a ·∫£nh tr√™n server:", publicId);
          } catch (err) {
            console.error("‚ùå L·ªói k·∫øt n·ªëi khi xo√° ·∫£nh:", err);
          }
        }

        // X√≥a m·∫£ng sau khi x·ª≠ l√Ω xong
        removedImages = [];
      }

      // Ch·ªâ g·ª≠i th√¥ng tin chung s·∫£n ph·∫©m
      const payload = {
        name: productNameInput.value.trim(),
        slug: productSlugInput.value.trim() || productNameInput.value.trim().toLowerCase().replace(/\s+/g, "-"),
        description: productDescriptionTextarea.value.trim(),
        category_id: parseInt(productCategorySelect.value),
        status: parseInt(productStatusSelect.value),
        materials: productMaterialInput.value.trim(),
        height: parseFloat(productHeightInput.value) || null,
        width: parseFloat(productWidthInput.value) || null,
        depth: parseFloat(productDepthInput.value) || null,
        seating_height: parseFloat(productSeatHeightInput.value) || null,
        max_weight_load: parseFloat(productMaxLoadInput.value) || null,
        main_image: mainImageUrl,
        room_ids: Array.from(productRoomsSelect.selectedOptions).map(opt => parseInt(opt.value)),
      };
      console.log("[PRODUCT PAYLOAD]", payload);

      // C·∫≠p nh·∫≠t s·∫£n ph·∫©m tr∆∞·ªõc
      const res = await fetch(`${API_URL}/api/products/admin/${slug}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (!res.ok) {
        if (result.errors && Array.isArray(result.errors)) {
          result.errors.forEach((err) => {
            const field = err.field;
            const message = err.message;

            // ===== L·ªói c·ªßa s·∫£n ph·∫©m chung =====
            if (field === "name") {
              showFieldError(productNameInput, message);
            } else if (field === "slug") {
              showFieldError(productSlugInput, message);
            } else if (field === "category_id") {
              showFieldError(productCategorySelect, message);
            } else if (field === "status") {
              showFieldError(productStatusSelect, message);
            } else if (field === "description") {
              showFieldError(productDescriptionTextarea, message);
            } else if (field === "height") {
              showFieldError(productHeightInput, message);
            } else if (field === "width") {
              showFieldError(productWidthInput, message);
            } else if (field === "depth") {
              showFieldError(productDepthInput, message);
            } else if (field === "seating_height") {
              showFieldError(productSeatHeightInput, message);
            } else if (field === "max_weight_load") {
              showFieldError(productMaxLoadInput, message);
            } else if (field === "materials") {
              showFieldError(productMaterialInput, message);
            }


            // ===== L·ªói c·ªßa bi·∫øn th·ªÉ =====
            else if (field.startsWith("variants[")) {
              const match = field.match(/variants\[(\d+)\]\.(.+)/);

              if (match) {
                const index = parseInt(match[1], 10);
                const fieldName = match[2];

                const variantEl = document.querySelectorAll("#variantsList .variant-item")[index];
                if (variantEl) {
                  let input;
                  if (fieldName === "slug") {
                    input = variantEl.querySelector(".variant-slug");
                  } else if (fieldName === "quantity") {
                    input = variantEl.querySelector(".variant-quantity");
                    console.log("[VALIDATE] T√¨m th·∫•y input quantity:", input);
                  } else if (fieldName === "price") {
                    input = variantEl.querySelector(".variant-price");
                  } else if (fieldName === "price_sale") {
                    input = variantEl.querySelector(".variant-sale-price");
                  } else if (fieldName === "color_id") {
                    input = variantEl.querySelector(".variant-color");
                  } else if (fieldName === "list_image") {
                    // N·∫øu mu·ªën hi·ªán l·ªói ·∫£nh, c√≥ th·ªÉ th√™m alert/tooltip g·∫ßn khung ·∫£nh
                    const imageGrid = variantEl.querySelector(".variant-image-grid");
                    if (imageGrid) {
                      const existingError = imageGrid.querySelector(".invalid-feedback");
                      if (!existingError) {
                        const errorBox = document.createElement("div");
                        errorBox.className = "invalid-feedback";
                        errorBox.style.display = "block";
                        errorBox.style.fontSize = "13px";
                        errorBox.style.color = "#dc3545";
                        errorBox.textContent = message;
                        imageGrid.appendChild(errorBox);
                      }
                    }
                    return;
                  }

                  if (input) {
                    showFieldError(input, message);
                  }

                }
              }
            }
          });
        }

        showToast("L·ªói khi c·∫≠p nh·∫≠t s·∫£n ph·∫©m", "danger");
        return;
      }

      showToast("C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!", "success");


      // === C·∫≠p nh·∫≠t ho·∫∑c x√≥a c√°c bi·∫øn th·ªÉ ƒë√£ c√≥ (KH√îNG t·∫°o m·ªõi ·ªü ƒë√¢y) ===
      const productId = result.product?.id || result.product?.product_id || result.product_id;
      const variantElements = document.querySelectorAll("#variantsList .variant-item");
      // X√ìA: console.log("== VARIANT ELEMENTS =="";
      // X√ìA: variantElements.forEach(el => { console.log("data-id:", el.getAttribute("data-id")); });

      // X·ª≠ l√Ω x√≥a c√°c bi·∫øn th·ªÉ ƒë√£ b·ªã remove kh·ªèi DOM
      const currentIds = Array.from(variantElements)
        .map(el => el.getAttribute("data-id"))
        .filter(Boolean);
      const loadedIds = Array.from(document.querySelectorAll("#variantsList .variant-item[data-id]"))
        .map(el => el.getAttribute("data-id"));
      const deletedIds = loadedIds.filter(id => !currentIds.includes(id));
      for (const delId of deletedIds) {
        if (delId) {
          await deleteVariant(delId);
        }
      }


      for (const variantEl of variantElements) {
        let variantId = variantEl.getAttribute("data-id");
        const color_id = parseInt(variantEl.querySelector(".variant-color")?.value || 0);
        const slug = variantEl.querySelector(".variant-slug")?.value.trim();
        const quantity = parseInt(variantEl.querySelector(".variant-quantity")?.value || 0);
        const price = parseFloat(variantEl.querySelector(".variant-price")?.value || 0);
        const price_sale = parseFloat(variantEl.querySelector(".variant-sale-price")?.value || 0);

        let finalVariantId = variantId;
        let list_image = [];

        const loadedImageBoxes = Array.from(
          variantEl.querySelectorAll(".variant-image-item.loaded")
        );

        // N·∫øu l√† bi·∫øn th·ªÉ m·ªõi, t·∫°o tr∆∞·ªõc khi upload ·∫£nh
        if (!finalVariantId) {
          const created = await addVariant(productId, {
            color_id,
            slug,
            quantity,
            price,
            price_sale,
            list_image: "", // T·∫°o t·∫°m, ·∫£nh s·∫Ω th√™m sau
          });

          if (!created || !created.variant_id) {
            showToast("Kh√¥ng th·ªÉ t·∫°o bi·∫øn th·ªÉ m·ªõi", "danger");
            continue;
          }

          finalVariantId = created.variant_id;
          variantEl.setAttribute("data-id", finalVariantId);
        }

        // Upload ·∫£nh n·∫øu l√† ·∫£nh base64
        for (const box of loadedImageBoxes) {
          const img = box.querySelector("img");
          const input = box.querySelector('input[type="file"]');
          if (!img) continue;

          const src = img.src;

          if (src.startsWith("http")) {
            list_image.push(src); // ·∫¢nh c≈© gi·ªØ nguy√™n
          } else if (src.startsWith("data:image/") && input?.files?.[0]) {
            const uploadedUrl = await uploadVariantImageToServer(finalVariantId, input.files[0]);
            if (uploadedUrl) {
              list_image.push(uploadedUrl);
              img.src = uploadedUrl;
              input.value = "";
            }
          }
        }

        // C·∫≠p nh·∫≠t l·∫°i list_image trong DOM v√† variantData
        variantEl.variantData = {
          color_id,
          slug,
          quantity,
          price,
          price_sale,
          list_image,
        };

        setupVariantImageUpload(variantEl); // C·∫≠p nh·∫≠t l·∫°i box ·∫£nh

        // G·ª≠i request c·∫≠p nh·∫≠t bi·∫øn th·ªÉ v·ªõi ·∫£nh ƒë√£ upload
        await updateVariant(finalVariantId, {
          color_id,
          slug,
          quantity,
          price,
          price_sale,
          list_image: list_image.join(","), // backend y√™u c·∫ßu d·∫°ng chu·ªói
        });
      }
      showToast("C·∫≠p nh·∫≠t bi·∫øn th·ªÉ th√†nh c√¥ng!", "success");
    } catch (err) {
      console.error("L·ªói khi l∆∞u s·∫£n ph·∫©m:", err);
      showToast("L·ªói khi l∆∞u s·∫£n ph·∫©m", "danger");
    }
  });
  window.addEventListener("DOMContentLoaded", () => {
    [productNameInput, productSlugInput, productCategorySelect, productStatusSelect, productDescriptionTextarea].forEach(input => {
      input.addEventListener("input", () => clearFieldError(input));
    });
  });

  async function updateVariant(variantId, data) {
    try {
      const res = await fetch(`${API_URL}/api/variants/${variantId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      const result = await res.json();
      if (!res.ok) {
        console.error("‚ùå L·ªói c·∫≠p nh·∫≠t variant:", result);
        showToast("C·∫≠p nh·∫≠t bi·∫øn th·ªÉ th·∫•t b·∫°i", "danger");
        return null;
      }

      console.log("‚úÖ C·∫≠p nh·∫≠t variant th√†nh c√¥ng:", result);
      return result;
    } catch (err) {
      console.error("‚ùå L·ªói k·∫øt n·ªëi khi g·ªçi updateVariant:", err);
      showToast("L·ªói k·∫øt n·ªëi khi c·∫≠p nh·∫≠t bi·∫øn th·ªÉ", "danger");
      return null;
    }
  }
  async function addVariant(productId, data) {
    try {
      const res = await fetch(`${API_URL}/api/variants/${productId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      });

      const result = await res.json();
      if (!res.ok) {
        console.error("‚ùå L·ªói t·∫°o bi·∫øn th·ªÉ:", result);
        showToast("T·∫°o bi·∫øn th·ªÉ th·∫•t b·∫°i", "danger");
        return null;
      }

      console.log("‚úÖ T·∫°o bi·∫øn th·ªÉ th√†nh c√¥ng:", result);
      return result;
    } catch (err) {
      console.error("‚ùå L·ªói k·∫øt n·ªëi khi g·ªçi addVariant:", err);
      showToast("L·ªói k·∫øt n·ªëi khi t·∫°o bi·∫øn th·ªÉ", "danger");
      return null;
    }
  }
  document.querySelector(".btn-add-variant").addEventListener("click", async function () {
    const newVariant = variantTemplate.cloneNode(true);
    newVariant.style.display = "block";
    newVariant.removeAttribute("id");
    newVariant.classList.add("variant-item");

    // Render dropdown m√†u
    const colorSelect = newVariant.querySelector(".variant-color");
    colorSelect.innerHTML = globalColors.map(
      (color) => `<option value="${color.color_id}">${color.color_name}</option>`
    ).join("");

    // Setup event
    setupVariantEvents(newVariant);
    variantsList.appendChild(newVariant);
  });

  // ƒê·∫£m b·∫£o ƒë·ªãnh nghƒ©a setupVariantEvents tr∆∞·ªõc khi g·ªçi trong loadProductDetail
  function setupVariantEvents(variantElement) {
    // Toggle n·ªôi dung bi·∫øn th·ªÉ
    variantElement
      .querySelector(".btn-toggle-variant")
      ?.addEventListener("click", function () {
        const content = variantElement.querySelector(".variant-content");
        const icon = this.querySelector("i");
        if (content.style.display === "none") {
          content.style.display = "block";
          icon.classList.replace("fa-chevron-down", "fa-chevron-up");
        } else {
          content.style.display = "none";
          icon.classList.replace("fa-chevron-up", "fa-chevron-down");
        }
      });
    variantElement.querySelectorAll("input, select").forEach((input) => {
      input.addEventListener("input", () => clearFieldError(input));
    });

    // X√≥a bi·∫øn th·ªÉ
    variantElement
      .querySelector(".btn-remove-variant")
      ?.addEventListener("click", async function () {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a bi·∫øn th·ªÉ n√†y?")) {
          const variantId = variantElement.getAttribute("data-id");

          // N·∫øu ƒë√£ c√≥ trong DB th√¨ g·ªçi API xo√°
          if (variantId) {
            await deleteVariant(variantId);
          }

          // D√π l√† m·ªõi hay c≈© c≈©ng xo√° kh·ªèi DOM
          console.log("[REMOVE VARIANT] ƒê√£ x√≥a bi·∫øn th·ªÉ kh·ªèi DOM:", variantId || "new (ch∆∞a c√≥ ID)");
          variantElement.remove();
        }
      });


    // T·ª± ƒë·ªông t·∫°o slug khi ch·ªçn m√†u
    const colorSelect = variantElement.querySelector(".variant-color");
    const slugInput = variantElement.querySelector(".variant-slug");
    if (colorSelect && slugInput) {
      colorSelect.addEventListener("change", () => {
        const selectedOption = colorSelect.options[colorSelect.selectedIndex];
        const colorName = selectedOption?.textContent?.trim() || "";
        if (colorName && !slugInput.value) {
          slugInput.value = colorName
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/[ƒëƒê]/g, "d")
            .replace(/[^a-z0-9]/g, "-")
            .replace(/-+/g, "-")
            .replace(/^-+|-+$/g, "");
        }
      });
    }

    const firstInvalid = document.querySelector(".is-invalid");
    if (firstInvalid) {
      firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    // X·ª≠ l√Ω upload ·∫£nh bi·∫øn th·ªÉ
    setupVariantImageUpload(variantElement);

    // Lu√¥n ƒë·∫£m b·∫£o ph·∫ßn .variant-content hi·ªÉn th·ªã khi th√™m m·ªõi
    const content = variantElement.querySelector(".variant-content");
    if (content) content.style.display = "block";

    // N·∫øu c√≥ s·∫µn ·∫£nh (khi load t·ª´ API), render l·∫°i ƒë√∫ng DOM structure cho t·ª´ng ·∫£nh
    const imageGrid = variantElement.querySelector(".variant-image-grid");
    if (imageGrid && variantElement.variantData?.list_image?.length) {
      imageGrid.innerHTML = "";
      variantElement.variantData.list_image.forEach((imgUrl) => {
        const imgBox = document.createElement("div");
        imgBox.className = "variant-image-item loaded";
        imgBox.innerHTML = `
            <img src="${imgUrl}" alt="Preview" style="width:80px;margin:5px;">
            <button class="remove-image"><i class="fas fa-times"></i></button>
          `;
        imgBox.querySelector(".remove-image").addEventListener("click", function (ev) {
          ev.stopPropagation();
          const publicId = extractPublicIdFromUrl(imgUrl);
          if (publicId) {
            removedImages.push(publicId);
            console.log("[REMOVE IMAGE] ƒê√£ ƒë√°nh d·∫•u x√≥a ·∫£nh bi·∫øn th·ªÉ:", publicId);
          }
          imgBox.remove();
          if (!imageGrid.querySelector('.variant-upload-box')) {
            imageGrid.appendChild(createUploadBox(imageGrid));
          }
        });
        imageGrid.appendChild(imgBox);
      });
      imageGrid.appendChild(createUploadBox(imageGrid));
    }
  }

  // H√†m upload ·∫£nh bi·∫øn th·ªÉ l√™n server v√† tr·∫£ v·ªÅ URL
  async function uploadVariantImageToServer(variantId, file) {
    const formData = new FormData();
    formData.append("image", file);
    formData.append("folder", "SonaSpace/Product");
    formData.append("subfolder", "variant");

    try {
      console.log(">> G·ª≠i file:", file);
      console.log(">> T√™n:", file.name);
      console.log(">> Type:", file.type);
      const res = await fetch(`${API_URL}/api/upload/product`, {
        method: "POST",
        body: formData,
      });

      const result = await res.json();
      if (!res.ok || !result.url) {
        showToast("L·ªói upload ·∫£nh: " + (result.error || "Kh√¥ng r√µ"), "danger");
        return null;
      }

      return result.url;
    } catch (error) {
      console.error("L·ªói k·∫øt n·ªëi:", error);
      showToast("L·ªói k·∫øt n·ªëi khi upload ·∫£nh", "danger");
      return null;
    }
  }
</script>

<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index:1050"></div>
<script>

  function showToast(message, type = "success") {
    let toastContainer = document.getElementById("toastContainer");
    if (!toastContainer) {
      toastContainer = document.createElement("div");
      toastContainer.id = "toastContainer";
      toastContainer.className = "position-fixed top-0 end-0 p-3";
      toastContainer.style.zIndex = "1050";
      document.body.appendChild(toastContainer);
    }

    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");

    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();

    toast.addEventListener("hidden.bs.toast", () => toast.remove());
  }

</script>



<!-- API -->

<!-- L·∫•y chi ti·∫øt s·∫£n ph·∫©m -->
<!-- GET /api/products/admin/:slug -->

<!-- L·∫•y danh s√°ch danh m·ª•c -->
<!-- GET /api/categories -->

<!-- L·∫•y danh s√°ch ph√≤ng -->
<!-- GET /api/rooms -->

<!-- L·∫•y danh s√°ch m√†u s·∫Øc -->
<!-- GET /api/color/filter -->

<!-- C·∫≠p nh·∫≠t s·∫£n ph·∫©m -->
<!-- PUT /api/products/admin/:slug -->

<!-- Th√™m ·∫£nh s·∫£n ph·∫©m-->
<!-- POST /api/upload/product -->

<!-- Xo√° ·∫£nh s·∫£n ph·∫©m -->
<!-- DELETE /api/upload/:publicId -->

<!-- T·∫°o bi·ªÉn th·ªÉ m·ªõi -->
<!-- POST /api/variants/:productId -->

<!-- C·∫≠p nh·∫≠t bi·∫øn th·ªÉ -->
<!-- PUT /api/variants/:variantId -->

<!-- Xo√° bi·∫øn th·ªÉ -->
<!-- DELETE /api/variants/:variantId -->