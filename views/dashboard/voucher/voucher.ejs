<!-- Trang Qu·∫£n l√Ω tin t·ª©c -->
<!-- Ti√™u ƒë·ªÅ v√† Thanh c√¥ng c·ª• -->
<div class="room_page">
    <div class="dashboard-header-row">
        <h2 class="dashboard-title">Voucher</h2>
        <div class="action-buttons">
            <button class="add-product-btn" onclick="window.location.href='/dashboard/voucher/addvoucher'">
                <i class="fas fa-plus"></i> Th√™m voucher
            </button>
        </div>
    </div>

    <!-- B·ªô l·ªçc v√† T√¨m ki·∫øm -->
    <div class="filter-row">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="T√¨m ki·∫øm m√£ gi·∫£m gi√°">
        </div>
        <div class="results-info">
            Hi·ªÉn th·ªã 1-6 trong t·ªïng s·ªë 500
        </div>
    </div>

    <div class="room-table-container">
        <table class="room-table" id="roomTable">
            <thead>
                <tr>
                    <th>M√£ gi·∫£m gi√°</th>
                    <th>Ti√™u ƒë·ªÅ</th>
                    <th>Gi√° gi·∫£m
                        <div class="header-filter">
                            <i class="fas fa-chevron-down filter-icon"></i>
                            <div class="filter-dropdown">
                                <a class="filter-item" href="#" data-sort-order="desc">Gi·∫£m theo %</a>
                                <a class="filter-item" href="#" data-sort-order="asc">Gi·∫£m theo vnƒë</a>
                                <a class="filter-item" href="#" data-filter-value="all">T·∫•t c·∫£</a>
                            </div>
                        </div>
                    </th>
                    <th>L∆∞·ª£t s·ª≠ d·ª•ng</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Th·ªùi gian b·∫Øt ƒë·∫ßu</th>
                    <th>Th·ªùi gian k·∫øt th√∫c</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c JS ƒë·ªï v√†o -->
            </tbody>
        </table>
    </div>
</div>

<div id="confirmationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>X√°c nh·∫≠n thao t√°c s·∫£n ph·∫©m</h3>
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="confirmActionBtn" class="btn btn-confirm">C√≥</button>
            <button id="cancelActionBtn" class="btn btn-cancel">Kh√¥ng</button>
        </div>
    </div>
</div>
<style>
    .header-filter {
        position: relative;
        cursor: pointer;
        display: inline-block;
        padding-left: 5px;
    }

    .filter-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 150px;
        display: none;
        padding: 4px 0;
    }

    .filter-dropdown.show {
        display: block;
    }

    .header-filter.active .filter-dropdown .header-filter.show {
        display: block;
    }

    .filter-dropdown a {
        display: block;
        padding: 8px 12px;
        text-decoration: none;
        color: #333;
        white-space: nowrap;
    }

    .filter-dropdown a:hover {
        background-color: #f0f0f0;
    }
</style>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const formatPrice = (price) => {
            const rounded = Math.round(price);
            return rounded.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        let originalVoucherList = [];
        let pendingToggle = {
            id: null,
            newStatus: null,
        };

        function getNews() {
            fetch("/api/couponcodes/admin")
                .then((response) => response.json())
                .then((data) => {
                    originalVoucherList = data;
                    renderVoucher(data);
                    console.log("Danh s√°ch voucher:", data);
                })
                .catch((error) => {
                    console.error("L·ªói khi t·∫£i danh s√°ch voucher:", error);
                    document.querySelector(".results-info").textContent = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.";
                });
        }

        function renderVoucher(VoucherList) {
            const tableBody = document.querySelector("#roomTable tbody");
            tableBody.innerHTML = "";

            VoucherList.forEach((voucher) => {
                const row = document.createElement("tr");
                const status = voucher.status === 1 ? "visible" : "hidden";

                row.innerHTML = `
                <td>${voucher.code}</td>
                <td>${voucher.title}</td>
                <td>${formatPrice(voucher.discount)}${voucher.discount_type === "percentage" ? "%" : "ƒë"}</td>
                <td>${voucher.used}</td>
                <td>
                    <span class="status-indicator ${status}">
                        <i class="fas ${status === "visible" ? "fa-eye" : "fa-eye-slash"}"></i>
                        ${status === "visible" ? "Hi·ªÉn th·ªã" : "·∫®n"}
                    </span>
                </td>
                <td>${formatDate(voucher.start_time)}</td>
                <td>${formatDate(voucher.exp_time)}</td>
                <td>
                    <div class="action-cell">
                        <button class="action-button edit" data-id="${voucher.id}"
                            onclick="window.location.href='/dashboard/voucher/editvoucher/${voucher.id}'"
                            title="Ch·ªânh s·ª≠a">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-button visibility" data-id="${voucher.id}"
                            data-status="${status}" title="${status === "visible" ? "·∫®n voucher" : "Hi·ªÉn th·ªã voucher"}">
                            <i class="fas ${status === "visible" ? "fa-eye-slash" : "fa-eye"}"></i>
                        </button>
                        <button class="action-button delete" data-id="${voucher.id}" data-title="${voucher.title}" title="X√≥a tin t·ª©c">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
                tableBody.appendChild(row);
            });

            // G·∫Øn s·ª± ki·ªán x√≥a
            document.querySelectorAll(".action-button.delete").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const voucherId = btn.getAttribute("data-id");
                    const voucherTitle = btn.getAttribute("data-title");
                    deleteVoucher(voucherId, voucherTitle);
                });
            });

            document.querySelector(".results-info").textContent = `Hi·ªÉn th·ªã ${VoucherList.length} k·∫øt qu·∫£`;
            // G·∫Øn s·ª± ki·ªán ·∫©n/hi·ªán
            document.querySelectorAll(".action-button.visibility").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const voucherId = btn.getAttribute("data-id");
                    const currentStatus = btn.getAttribute("data-status"); // 'visible' ho·∫∑c 'hidden'
                    const newStatus = currentStatus === "visible" ? 0 : 1;

                    pendingToggle = {
                        id: voucherId,
                        newStatus: newStatus
                    };

                    const actionText = newStatus === 1 ? "hi·ªÉn th·ªã" : "·∫©n";
                    document.getElementById("modalMessage").textContent = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${actionText} voucher n√†y?`;

                    document.getElementById("confirmationModal").style.display = "flex";
                });
            });
            document.getElementById("confirmActionBtn").addEventListener("click", () => {
                if (pendingToggle.id !== null) {
                    toggleVoucherVisibility(pendingToggle.id, pendingToggle.newStatus);
                    pendingToggle = { id: null, newStatus: null };
                }
                document.getElementById("confirmationModal").style.display = "none";
            });

            document.getElementById("cancelActionBtn").addEventListener("click", () => {
                pendingToggle = { id: null, newStatus: null };
                document.getElementById("confirmationModal").style.display = "none";
            });


        }
        function toggleVoucherVisibility(voucherId, newStatus) {
            const token = localStorage.getItem("token");

            fetch(`/api/couponcodes/${voucherId}/status`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ status: newStatus }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.error) {
                        showToast(data.error, "danger");
                    } else {
                        showToast(`ƒê√£ ${newStatus === 1 ? "hi·ªÉn th·ªã" : "·∫©n"} voucher`, "success");
                        setTimeout(() => getNews(), 500); // T·∫£i l·∫°i danh s√°ch
                    }
                })
                .catch((err) => {
                    console.error("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:", err);
                    showToast("L·ªói khi thay ƒë·ªïi tr·∫°ng th√°i voucher", "danger");
                });
        }

        function deleteVoucher(voucherId, voucherTitle) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a voucher "${voucherTitle}"?`)) return;

            const token = localStorage.getItem("token");

            fetch(`/api/couponcodes/${voucherId}`, {
                method: "DELETE",
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.error) {
                        showToast(data.error, "danger");
                    } else {
                        showToast("X√≥a voucher th√†nh c√¥ng", "success");
                        setTimeout(() => location.reload(), 1000);
                    }
                })
                .catch((err) => {
                    console.error("L·ªói khi x√≥a voucher:", err);
                    showToast("X·∫£y ra l·ªói khi x√≥a voucher", "danger");
                });
        }

        function formatDate(dateStr) {
            if (!dateStr) return "-";
            return new Date(dateStr).toLocaleDateString("vi-VN");
        }

        //  T√¨m ki·∫øm
        const searchInput = document.querySelector(".search-input");
        searchInput.addEventListener("input", function () {
            const keyword = this.value.trim().toLowerCase();

            const filtered = originalVoucherList.filter((voucher) =>
                voucher.code.toLowerCase().includes(keyword) ||
                voucher.title.toLowerCase().includes(keyword)
            );

            renderVoucher(filtered);
        });

        // üü° L·ªçc theo lo·∫°i gi·∫£m gi√°
        function filterByDiscountType(type) {
            if (type === "all") {
                renderVoucher(originalVoucherList);
                return;
            }

            const filtered = originalVoucherList.filter((voucher) => {
                return voucher.discount_type === (type === "percentage" ? "percentage" : "fixed");
            });

            renderVoucher(filtered);
        }

        //  G·∫Øn s·ª± ki·ªán cho m·ª•c trong dropdown l·ªçc
        document.querySelectorAll(".header-filter .filter-item").forEach((item) => {
            item.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();

                const sortOrder = item.getAttribute("data-sort-order");
                const filterValue = item.getAttribute("data-filter-value");

                if (filterValue === "all") {
                    filterByDiscountType("all");
                } else if (sortOrder === "desc") {
                    filterByDiscountType("percentage");
                } else if (sortOrder === "asc") {
                    filterByDiscountType("fixed");
                }

                // ·∫®n dropdown sau khi ch·ªçn
                document.querySelectorAll(".filter-dropdown").forEach((dropdown) => {
                    dropdown.classList.remove("show");
                });
            });
        });

        document.querySelectorAll(".header-filter").forEach((filter) => {
            const icon = filter.querySelector(".filter-icon"); // ƒê·ªïi ƒë√∫ng class c√≥ th·∫≠t
            const dropdown = filter.querySelector(".filter-dropdown");

            if (!icon) return;

            icon.addEventListener("click", (e) => {
                e.stopPropagation(); // NgƒÉn click lan ra ngo√†i
                const isActive = filter.classList.contains("active");

                // ƒê√≥ng t·∫•t c·∫£ filter kh√°c
                document.querySelectorAll(".header-filter").forEach((f) => {
                    f.classList.remove("active");
                    const d = f.querySelector(".filter-dropdown");
                    if (d) d.classList.remove("show");
                });

                // Toggle n·∫øu ch∆∞a m·ªü
                if (!isActive) {
                    filter.classList.add("active");
                    dropdown.classList.add("show");
                }
            });
        });


        // Click ra ngo√†i th√¨ ƒë√≥ng dropdown
        document.addEventListener("click", () => {
            document.querySelectorAll(".header-filter").forEach((filter) => {
                filter.classList.remove("active");
                filter.querySelector(".filter-dropdown").classList.remove("show");
            });
        });




        //  Kh·ªüi ƒë·ªông
        getNews();
    });
</script>